<!DOCTYPE html>
<html lang="ms">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>eKehadiran SK Masjid Tanah</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">
    
    <!-- FontAwesome Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <!-- Export Libraries -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.29/jspdf.plugin.autotable.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

    <!-- Firebase SDK (Compat Version) -->
    <script src="https://www.gstatic.com/firebasejs/10.13.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.13.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.13.0/firebase-firestore-compat.js"></script>

    <style>
        body { font-family: 'Inter', sans-serif; background-color: #f0f9ff; }
        h1, h2, h3, .font-heading { font-family: 'Poppins', sans-serif; }
        .fade-in { animation: fadeIn 0.5s ease-in-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .btn-loading { position: relative; color: transparent !important; pointer-events: none; }
        .btn-loading::after {
            content: ""; position: absolute; width: 1em; height: 1em;
            top: 50%; left: 50%; margin-top: -0.5em; margin-left: -0.5em;
            border: 2px solid #ffffff; border-radius: 50%; border-top-color: transparent;
            animation: spin 0.6s linear infinite;
        }
        @keyframes spin { to { transform: rotate(360deg); } }
        .custom-scrollbar::-webkit-scrollbar { width: 6px; height: 6px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: #f1f1f1; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 3px; }
    </style>
</head>
<body class="text-slate-800">

    <div id="app" class="min-h-screen flex flex-col">
        
        <!-- Navbar -->
        <nav id="navbar" class="bg-white shadow-sm border-b border-slate-200 hidden sticky top-0 z-50">
            <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
                <div class="flex justify-between h-16">
                    <div class="flex items-center">
                        <div class="flex-shrink-0 flex items-center gap-3 text-blue-600">
                            <img src="https://i.postimg.cc/k4N1mPR1/semat-04.png" alt="Logo Sekolah" class="h-10 w-auto object-contain">
                            <span class="font-heading font-bold text-xl tracking-tight">eKehadiran SKMT</span>
                        </div>
                        <div class="hidden md:ml-6 md:flex md:space-x-4" id="navbarLinks"></div>
                    </div>
                    <div class="flex items-center gap-3">
                        <span id="userGreeting" class="text-sm font-medium text-slate-600 hidden sm:block"></span>
                        <button onclick="logout()" title="Log Keluar" class="text-slate-500 hover:text-red-500 transition-colors p-2 rounded-full hover:bg-red-50">
                            <i class="fa-solid fa-right-from-bracket text-lg"></i>
                        </button>
                    </div>
                </div>
            </div>
        </nav>

        <!-- Main Content -->
        <main class="flex-grow container mx-auto px-4 py-6 relative">
            
            <!-- 1. LANDING PAGE -->
            <div id="view-landing" class="flex flex-col items-center justify-center min-h-[80vh] fade-in pb-10">
                <div class="text-center mb-8 mt-4">
                    <img src="https://i.postimg.cc/k4N1mPR1/semat-04.png" alt="Logo Sekolah" class="w-32 h-auto mx-auto mb-4 object-contain drop-shadow-sm">
                    <h1 class="text-3xl font-bold text-slate-800 mb-1">eKehadiran SK Masjid Tanah</h1>
                    <p class="text-slate-500 text-sm">Sistem Pengurusan Kehadiran Digital</p>
                </div>

                <div class="w-full max-w-4xl mb-10">
                    <div class="bg-white rounded-2xl shadow-xl border border-blue-50 overflow-hidden">
                        <div class="bg-gradient-to-r from-blue-600 to-blue-500 px-6 py-4 text-white flex justify-between items-center">
                            <div>
                                <h2 class="font-bold text-lg"><i class="fa-regular fa-calendar-check mr-2"></i>Ringkasan Hari Ini</h2>
                                <p class="text-blue-100 text-xs" id="landingDateDisplay">Memuatkan...</p>
                            </div>
                            <button onclick="loadLandingStats()" class="text-white hover:bg-white/20 p-2 rounded-full transition"><i class="fa-solid fa-rotate-right"></i></button>
                        </div>
                        <div class="p-6">
                            <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                                <div class="col-span-1 flex flex-col items-center justify-center border-b md:border-b-0 md:border-r border-slate-100 pb-6 md:pb-0">
                                    <div class="relative w-32 h-32">
                                        <svg class="w-full h-full" viewBox="0 0 36 36">
                                            <path class="text-slate-100" d="M18 2.0845 a 15.9155 15.9155 0 0 1 0 31.831 a 15.9155 15.9155 0 0 1 0 -31.831" fill="none" stroke="currentColor" stroke-width="3" />
                                            <path id="landingCirclePath" class="text-blue-600 transition-all duration-1000 ease-out" stroke-dasharray="0, 100" d="M18 2.0845 a 15.9155 15.9155 0 0 1 0 31.831 a 15.9155 15.9155 0 0 1 0 -31.831" fill="none" stroke="currentColor" stroke-width="3" />
                                        </svg>
                                        <div class="absolute inset-0 flex items-center justify-center flex-col">
                                            <span class="text-3xl font-bold text-slate-800" id="landingPercent">0%</span>
                                            <span class="text-[10px] text-slate-400 uppercase tracking-wider">Kehadiran</span>
                                        </div>
                                    </div>
                                    <p class="text-xs text-center text-slate-500 mt-2">Daripada jumlah keseluruhan murid</p>
                                </div>
                                <div class="col-span-2">
                                    <h3 class="font-bold text-slate-700 mb-3 text-sm">Status Pengisian Kelas</h3>
                                    <div class="overflow-y-auto max-h-48 pr-2 custom-scrollbar">
                                        <div id="landingClassList" class="grid grid-cols-1 sm:grid-cols-2 gap-2">
                                            <div class="animate-pulse bg-slate-100 h-8 rounded col-span-2"></div>
                                        </div>
                                    </div>
                                    <div class="mt-4 flex gap-4 text-xs text-slate-500 border-t pt-3">
                                        <div class="flex items-center gap-1"><span class="w-2 h-2 rounded-full bg-emerald-500"></span> Selesai</div>
                                        <div class="flex items-center gap-1"><span class="w-2 h-2 rounded-full bg-slate-300"></span> Belum Isi</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 w-full max-w-xl">
                    <button onclick="showLogin('teacher')" class="group bg-white p-6 rounded-xl shadow-md hover:shadow-lg transition-all border border-slate-100 hover:border-blue-400 flex items-center gap-4 text-left">
                        <div class="bg-blue-50 p-3 rounded-full group-hover:bg-blue-100 transition-colors"><i class="fa-solid fa-chalkboard-user text-2xl text-blue-600"></i></div>
                        <div><h3 class="font-bold text-slate-800">Log Masuk Guru</h3><p class="text-xs text-slate-500">Isi kehadiran murid</p></div>
                    </button>
                    <button onclick="showLogin('admin')" class="group bg-white p-6 rounded-xl shadow-md hover:shadow-lg transition-all border border-slate-100 hover:border-emerald-400 flex items-center gap-4 text-left">
                        <div class="bg-emerald-50 p-3 rounded-full group-hover:bg-emerald-100 transition-colors"><i class="fa-solid fa-user-shield text-2xl text-emerald-600"></i></div>
                        <div><h3 class="font-bold text-slate-800">Log Masuk Superadmin</h3><p class="text-xs text-slate-500">Akses penuh sistem (Admin Utama)</p></div>
                    </button>
                </div>
            </div>

            <!-- 2. TEACHER LOGIN -->
            <div id="view-login-teacher" class="hidden max-w-md mx-auto mt-10 fade-in">
                <button onclick="goBack()" class="mb-4 text-slate-500 hover:text-blue-600 flex items-center gap-2"><i class="fa-solid fa-arrow-left"></i> Kembali</button>
                <div class="bg-white rounded-2xl shadow-lg p-8">
                    <h2 class="text-2xl font-bold mb-6 text-blue-600">Log Masuk Guru</h2>
                    <form onsubmit="handleTeacherLogin(event)">
                        <div class="mb-4"><label class="block text-sm font-medium text-slate-700 mb-1">Nama Guru</label><select id="teacherSelect" class="w-full p-2.5 border rounded-lg"><option value="">Pilih Nama...</option></select></div>
                        <div class="mb-6">
                            <label class="block text-sm font-medium text-slate-700 mb-1">Kata Laluan</label>
                            <input type="password" id="teacherIc" class="w-full p-2.5 border rounded-lg" placeholder="••••" required>
                        </div>
                        <button type="submit" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 rounded-lg">Masuk</button>
                    </form>
                </div>
            </div>

            <!-- 3. ADMIN LOGIN -->
            <div id="view-login-admin" class="hidden max-w-md mx-auto mt-10 fade-in">
                <button onclick="goBack()" class="mb-4 text-slate-500 hover:text-emerald-600 flex items-center gap-2"><i class="fa-solid fa-arrow-left"></i> Kembali</button>
                <div class="bg-white rounded-2xl shadow-lg p-8">
                    <h2 class="text-2xl font-bold mb-6 text-emerald-600">Log Masuk Superadmin</h2>
                    <form onsubmit="handleAdminLogin(event)">
                        <div class="mb-4"><label class="block text-sm font-medium text-slate-700 mb-1">ID Pengguna</label><input type="text" id="adminUser" class="w-full p-2.5 border rounded-lg" required></div>
                        <div class="mb-6"><label class="block text-sm font-medium text-slate-700 mb-1">Kata Laluan</label><input type="password" id="adminPass" class="w-full p-2.5 border rounded-lg" required></div>
                        <button type="submit" class="w-full bg-emerald-600 hover:bg-emerald-700 text-white font-bold py-3 rounded-lg">Masuk</button>
                    </form>
                </div>
            </div>

            <!-- 4. TEACHER DASHBOARD -->
            <div id="view-teacher-dashboard" class="hidden fade-in pb-20">
                <div class="bg-white rounded-xl shadow-sm p-4 mb-6 border border-slate-100">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                        <div>
                            <label class="block text-xs font-bold text-slate-500 uppercase mb-1">Tarikh</label>
                            <input type="date" id="attendanceDate" onchange="checkTuesday()" class="rounded-lg border-slate-300 block w-full p-2 border text-sm">
                        </div>
                        <div id="attTypeContainer" class="hidden">
                            <label class="block text-xs font-bold text-slate-500 uppercase mb-1">Sesi Kehadiran</label>
                            <div class="flex space-x-2 bg-slate-100 p-1 rounded-lg">
                                <button onclick="setAttType('class')" id="btnTypeClass" class="flex-1 py-1 px-3 rounded text-xs font-bold bg-white shadow text-blue-600 transition">Kelas (Pagi)</button>
                                <button onclick="setAttType('koku')" id="btnTypeKoku" class="flex-1 py-1 px-3 rounded text-xs font-bold text-slate-500 hover:bg-white transition">Kokurikulum (Petang)</button>
                            </div>
                        </div>
                    </div>
                    <div id="filterClassContainer">
                        <label class="block text-xs font-bold text-slate-500 uppercase mb-1">Kelas</label>
                        <select id="teacherClassSelect" onchange="loadStudentsForAttendance()" class="rounded-lg border-slate-300 block w-full p-2 border text-sm bg-white"><option value="">Pilih Kelas...</option></select>
                    </div>
                    <div id="filterKokuContainer" class="hidden space-y-3">
                        <div class="flex gap-4">
                            <div class="w-1/2"><label class="block text-xs font-bold text-slate-500 uppercase mb-1">Minggu Koku Ke-</label><input type="number" id="kokuWeek" class="rounded-lg border-slate-300 block w-full p-2 border text-sm" placeholder="Contoh: 1"></div>
                            <div class="w-1/2"><label class="block text-xs font-bold text-slate-500 uppercase mb-1">Kategori</label><select id="kokuCategory" onchange="loadKokuUnits()" class="rounded-lg border-slate-300 block w-full p-2 border text-sm bg-white"><option value="">Pilih Kategori...</option><option value="unit_beruniform">Unit Beruniform</option><option value="kelab_persatuan">Kelab & Persatuan</option><option value="sukan_permainan">Sukan & Permainan</option></select></div>
                        </div>
                        <div><label class="block text-xs font-bold text-slate-500 uppercase mb-1">Nama Unit</label><select id="kokuUnitSelect" onchange="loadStudentsForAttendance()" class="rounded-lg border-slate-300 block w-full p-2 border text-sm bg-white" disabled><option value="">Pilih Unit...</option></select></div>
                    </div>
                </div>
                <div id="attendanceWorkspace" class="hidden">
                    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                        <div class="lg:col-span-2">
                            <div class="bg-white rounded-xl shadow-lg border border-slate-100 overflow-hidden">
                                <div class="bg-slate-50 px-6 py-4 border-b border-slate-200 flex justify-between items-center">
                                    <h3 class="font-bold text-slate-700" id="attListTitle">Senarai Kehadiran</h3>
                                    <span class="text-xs bg-blue-100 text-blue-700 px-2 py-1 rounded-full font-medium" id="classNameDisplay"></span>
                                </div>
                                <div class="overflow-x-auto"><table class="w-full text-sm text-left"><thead class="text-xs text-slate-500 uppercase bg-slate-50 border-b"><tr><th class="px-6 py-3 w-10">#</th><th class="px-6 py-3">Nama Murid</th><th class="px-6 py-3">Info</th><th class="px-6 py-3 text-center w-24">Hadir</th></tr></thead><tbody id="attendanceTableBody"></tbody></table></div>
                                <div id="emptyState" class="hidden p-8 text-center text-slate-400"><p>Tiada murid dijumpai.</p></div>
                            </div>
                        </div>
                        <div class="lg:col-span-1">
                            <div class="bg-white rounded-xl shadow-lg border border-slate-100 p-6 sticky top-24">
                                <h3 class="font-bold text-slate-800 mb-4 border-b pb-2">Ringkasan</h3>
                                <div class="space-y-3 mb-6">
                                    <div class="flex justify-between text-sm"><span class="text-slate-500">Jumlah Murid</span><span id="summaryTotal" class="font-bold">0</span></div>
                                    <div class="flex justify-between text-sm"><span class="text-slate-500">Hadir</span><span id="summaryPresent" class="font-bold text-green-600">0</span></div>
                                    <div class="flex justify-between text-sm"><span class="text-slate-500">Tidak Hadir</span><span id="summaryAbsent" class="font-bold text-red-600">0</span></div>
                                    <div class="mt-4 pt-4 border-t"><div class="flex justify-between items-end mb-1"><span class="text-xs font-bold uppercase text-slate-400">Peratus Kehadiran</span><span id="summaryPercentText" class="text-2xl font-bold text-blue-600">0%</span></div><div class="w-full bg-slate-200 rounded-full h-2.5"><div id="summaryProgressBar" class="bg-blue-600 h-2.5 rounded-full" style="width: 0%"></div></div></div>
                                </div>
                                <button onclick="submitAttendance()" id="btnSubmitAttendance" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 rounded-lg mb-3 flex items-center justify-center gap-2"><i class="fa-solid fa-save"></i> Simpan & Hantar</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 5. ADMIN DASHBOARD -->
            <div id="view-admin-dashboard" class="hidden fade-in pb-20">
                <!-- Admin Config -->
                <div class="mb-6 p-4 bg-slate-100 rounded-xl border border-slate-200">
                    <details>
                        <summary class="cursor-pointer font-bold text-slate-600 text-sm select-none">Tetapan Telegram Bot API</summary>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mt-3">
                            <div><label class="block text-xs text-slate-500 mb-1">Bot Token</label><input type="text" id="tgBotToken" class="w-full text-xs p-2 rounded border" placeholder="123456:ABC-..."></div>
                            <div><label class="block text-xs text-slate-500 mb-1">Chat ID</label><input type="text" id="tgChatId" class="w-full text-xs p-2 rounded border" placeholder="-100..."></div>
                            <div class="md:col-span-2 flex justify-end"><button onclick="saveTelegramSettings()" class="bg-slate-800 text-white text-xs px-3 py-1 rounded hover:bg-slate-900">Simpan Tetapan</button></div>
                        </div>
                    </details>
                </div>

                <div class="flex space-x-1 bg-slate-100 p-1 rounded-xl mb-6 overflow-x-auto">
                    <button onclick="switchAdminTab('teachers')" class="admin-tab flex-1 py-2.5 px-4 rounded-lg text-sm font-medium transition-all" id="tab-btn-teachers">Guru</button>
                    <button onclick="switchAdminTab('students')" class="admin-tab flex-1 py-2.5 px-4 rounded-lg text-sm font-medium transition-all" id="tab-btn-students">Murid</button>
                    <button onclick="switchAdminTab('history')" class="admin-tab flex-1 py-2.5 px-4 rounded-lg text-sm font-medium transition-all" id="tab-btn-history">Laporan & Analisis</button>
                    <button onclick="switchAdminTab('utiliti')" class="admin-tab flex-1 py-2.5 px-4 rounded-lg text-sm font-medium transition-all" id="tab-btn-utiliti">Utiliti</button>
                </div>

                <!-- TAB: Teachers -->
                <div id="tab-teachers" class="admin-content hidden">
                     <div class="bg-white rounded-xl shadow p-6 mb-6 border-l-4 border-emerald-500">
                        <h3 class="font-bold text-lg mb-4">Tambah / Edit Guru</h3>
                        <div class="mb-4 p-4 bg-blue-50 rounded-lg border border-blue-100">
                            <p class="text-xs font-bold text-blue-600 mb-2"><i class="fa-solid fa-file-csv"></i> Muat Naik Pukal (CSV)</p>
                            <div class="flex gap-2 items-center">
                                <input type="file" id="csvGuru" accept=".csv" class="block w-full text-xs text-slate-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-xs file:font-semibold file:bg-blue-100 file:text-blue-700 hover:file:bg-blue-200">
                                <button onclick="processCsvGuru()" class="bg-blue-600 text-white text-xs px-3 py-2 rounded hover:bg-blue-700">Upload</button>
                            </div>
                            <p class="text-[10px] text-slate-500 mt-1">Format: Nama, IC, Peranan (Guru/Admin)</p>
                        </div>
                        <form onsubmit="saveTeacher(event)" class="grid grid-cols-1 md:grid-cols-12 gap-4 border-t pt-4">
                            <input type="hidden" id="editTeacherId">
                            <div class="md:col-span-6"><input type="text" id="inputTeacherName" placeholder="Nama Guru" class="w-full p-2 border rounded-lg" required></div>
                            <div class="md:col-span-2"><input type="text" id="inputTeacherIc" placeholder="Kata Laluan" maxlength="4" pattern="\d{4}" class="w-full p-2 border rounded-lg" required></div>
                            <div class="md:col-span-2">
                                <select id="inputTeacherRole" class="w-full p-2 border rounded-lg bg-white">
                                    <option value="guru">Guru</option>
                                    <option value="admin">Admin</option>
                                </select>
                            </div>
                            <div class="md:col-span-2"><button type="submit" id="btnSaveTeacher" class="w-full bg-emerald-600 text-white p-2 rounded-lg font-medium hover:bg-emerald-700">Simpan</button></div>
                        </form>
                    </div>
                    <div class="bg-white rounded-xl shadow overflow-hidden mb-6">
                        <table class="w-full text-sm text-left"><thead class="bg-slate-50 border-b text-slate-500 uppercase text-xs"><tr><th class="px-6 py-3">Nama</th><th class="px-6 py-3">Kata Laluan</th><th class="px-6 py-3">Peranan</th><th class="px-6 py-3 text-right">Aksi</th></tr></thead><tbody id="teacherTableBody"></tbody></table>
                    </div>
                    
                    <div class="p-4 bg-red-50 border border-red-200 rounded-xl">
                        <h4 class="font-bold text-red-700 text-sm mb-2"><i class="fa-solid fa-triangle-exclamation"></i> Zon Bahaya</h4>
                        <div class="flex justify-between items-center flex-wrap gap-2">
                            <p class="text-xs text-red-600">Tindakan ini akan memadamkan <b>SEMUA</b> data guru dalam sistem.</p>
                            <button onclick="confirmDeleteAll('teachers')" class="bg-white border border-red-300 text-red-600 hover:bg-red-600 hover:text-white px-4 py-2 rounded-lg text-xs font-bold transition-colors">
                                Padam Semua Guru
                            </button>
                        </div>
                    </div>
                </div>

                <!-- TAB: Students -->
                <div id="tab-students" class="admin-content hidden">
                    <div class="bg-white rounded-xl shadow p-6 mb-6 border-l-4 border-emerald-500">
                        <h3 class="font-bold text-lg mb-4">Tambah / Edit Murid</h3>
                        <div class="mb-4 p-4 bg-blue-50 rounded-lg border border-blue-100">
                            <p class="text-xs font-bold text-blue-600 mb-2"><i class="fa-solid fa-file-csv"></i> Muat Naik Pukal (CSV)</p>
                            <div class="flex gap-2 items-center">
                                <input type="file" id="csvMurid" accept=".csv" class="block w-full text-xs text-slate-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-xs file:font-semibold file:bg-blue-100 file:text-blue-700 hover:file:bg-blue-200">
                                <button onclick="processCsvMurid()" class="bg-blue-600 text-white text-xs px-3 py-2 rounded hover:bg-blue-700">Upload</button>
                            </div>
                            <p class="text-[10px] text-slate-500 mt-1">Format: Nama, Kelas, RMT, Unit, Kelab, Sukan</p>
                        </div>
                        <form onsubmit="saveStudent(event)" class="grid grid-cols-1 md:grid-cols-12 gap-4 border-t pt-4">
                            <input type="hidden" id="editStudentId">
                            <div class="md:col-span-4"><input type="text" id="inputStudentName" placeholder="Nama Murid" class="w-full p-2 border rounded-lg" required></div>
                            <div class="md:col-span-2"><input type="text" id="inputStudentClass" placeholder="Kelas" class="w-full p-2 border rounded-lg" required></div>
                            <div class="md:col-span-2"><select id="inputStudentRmt" class="w-full p-2 border rounded-lg bg-white"><option value="Tidak">RMT: Tidak</option><option value="Ya">RMT: Ya</option></select></div>
                            <div class="md:col-span-4 grid grid-cols-3 gap-2">
                                <input type="text" id="inputUnit" placeholder="Unit" class="w-full p-2 border rounded-lg text-xs">
                                <input type="text" id="inputClub" placeholder="Kelab" class="w-full p-2 border rounded-lg text-xs">
                                <input type="text" id="inputSport" placeholder="Sukan" class="w-full p-2 border rounded-lg text-xs">
                            </div>
                            <div class="md:col-span-12"><button type="submit" id="btnSaveStudent" class="w-full bg-emerald-600 text-white p-2 rounded-lg font-medium hover:bg-emerald-700">Simpan</button></div>
                        </form>
                    </div>
                     <div class="mb-4 flex flex-wrap gap-2">
                        <input type="text" id="searchStudent" placeholder="Cari nama..." class="p-2 border rounded-lg text-sm w-full md:w-64" onkeyup="applyStudentFilters()">
                        <select id="filterStudentClass" class="p-2 border rounded-lg text-sm w-full md:w-48" onchange="applyStudentFilters()">
                            <option value="">Semua Kelas</option>
                        </select>
                        <select id="sortStudent" class="p-2 border rounded-lg text-sm w-full md:w-48" onchange="applyStudentFilters()">
                            <option value="name_asc">Nama (A-Z)</option>
                            <option value="name_desc">Nama (Z-A)</option>
                            <option value="class_asc">Kelas (A-Z)</option>
                        </select>
                     </div>
                     <div class="bg-white rounded-xl shadow overflow-hidden mb-6"><div class="overflow-x-auto custom-scrollbar"><table class="w-full text-sm text-left"><thead class="bg-slate-50 border-b text-slate-500 uppercase text-xs"><tr><th class="px-6 py-3">Nama</th><th class="px-6 py-3">Kelas</th><th class="px-6 py-3">RMT</th><th class="px-6 py-3">Koku</th><th class="px-6 py-3 text-right">Aksi</th></tr></thead><tbody id="studentTableBody"></tbody></table></div></div>
                    
                    <div class="p-4 bg-red-50 border border-red-200 rounded-xl">
                        <h4 class="font-bold text-red-700 text-sm mb-2"><i class="fa-solid fa-triangle-exclamation"></i> Zon Bahaya</h4>
                        <div class="flex justify-between items-center flex-wrap gap-2">
                            <p class="text-xs text-red-600">Tindakan ini akan memadamkan <b>SEMUA</b> data murid dalam sistem.</p>
                            <button onclick="confirmDeleteAll('students')" class="bg-white border border-red-300 text-red-600 hover:bg-red-600 hover:text-white px-4 py-2 rounded-lg text-xs font-bold transition-colors">
                                Padam Semua Murid
                            </button>
                        </div>
                    </div>
                </div>
                
                <!-- TAB: Utility (Auto Koku) -->
                <div id="tab-utiliti" class="admin-content hidden">
                    <div class="max-w-lg mx-auto bg-white rounded-xl shadow-lg p-8 border border-indigo-100">
                        <div class="text-center mb-6">
                            <div class="w-16 h-16 bg-indigo-100 rounded-full flex items-center justify-center mx-auto mb-4">
                                <i class="fa-solid fa-wand-magic-sparkles text-2xl text-indigo-600"></i>
                            </div>
                            <h3 class="text-xl font-bold text-slate-800">Auto Jana Kehadiran Koku</h3>
                            <p class="text-sm text-slate-500 mt-1">Salin kehadiran dari Kelas Pagi ke Unit Koku Petang</p>
                        </div>
                        <div class="space-y-4">
                            <div><label class="block text-xs font-bold text-slate-500 uppercase mb-1">Tarikh (Pagi)</label><input type="date" id="autoKokuDate" class="w-full p-3 border rounded-lg text-sm focus:ring-2 focus:ring-indigo-500 outline-none"></div>
                            <div><label class="block text-xs font-bold text-slate-500 uppercase mb-1">Kategori Unit</label><select id="autoKokuCategory" class="w-full p-3 border rounded-lg text-sm bg-white focus:ring-2 focus:ring-indigo-500 outline-none"><option value="unit_beruniform">Unit Beruniform</option><option value="kelab_persatuan">Kelab & Persatuan</option><option value="sukan_permainan">Sukan & Permainan</option></select></div>
                            <div><label class="block text-xs font-bold text-slate-500 uppercase mb-1">Minggu Koku Ke-</label><input type="number" id="autoKokuWeek" class="w-full p-3 border rounded-lg text-sm focus:ring-2 focus:ring-indigo-500 outline-none" placeholder="Contoh: 3"></div>
                            <div class="pt-4"><button id="btnAutoKoku" onclick="runAutoKoku()" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-3 rounded-lg shadow-md transition-all flex items-center justify-center gap-2"><i class="fa-solid fa-gears"></i> Proses Kehadiran</button></div>
                            <div class="bg-yellow-50 border border-yellow-100 rounded-lg p-3 text-xs text-yellow-800 mt-4"><i class="fa-solid fa-circle-info mr-1"></i> Sistem akan mencari semua murid yang hadir pada sesi pagi dan merekodkan kehadiran petang mereka mengikut unit yang ditetapkan dalam profil murid.</div>
                        </div>
                    </div>
                </div>

                <!-- TAB: History / Analysis -->
                <div id="tab-history" class="admin-content hidden">
                    <div class="grid grid-cols-1 sm:grid-cols-3 gap-4 mb-6">
                        <div class="bg-blue-600 text-white p-4 rounded-xl shadow"><p class="text-xs opacity-80 uppercase font-bold">Jumlah Guru</p><h3 class="text-2xl font-bold" id="statTotalTeachers">0</h3></div>
                        <div class="bg-emerald-600 text-white p-4 rounded-xl shadow"><p class="text-xs opacity-80 uppercase font-bold">Jumlah Murid</p><h3 class="text-2xl font-bold" id="statTotalStudents">0</h3></div>
                        <div class="bg-white text-slate-700 p-4 rounded-xl shadow border border-slate-200 relative overflow-hidden"><p class="text-xs text-slate-400 uppercase font-bold mb-1">Pecahan Murid/Kelas</p><div class="h-12 overflow-y-auto text-xs custom-scrollbar" id="statClassBreakdown">Loading...</div></div>
                    </div>
                    <div class="flex space-x-1 bg-slate-200 p-1 rounded-lg mb-6 overflow-x-auto">
                        <button onclick="showAnalysisView('daily')" class="analysis-tab flex-1 py-1.5 rounded-md text-xs font-bold transition-all bg-white shadow text-slate-700" id="btn-an-daily">Rekod Harian</button>
                        <button onclick="showAnalysisView('koku')" class="analysis-tab flex-1 py-1.5 rounded-md text-xs font-bold transition-all text-slate-500 hover:bg-white/50" id="btn-an-koku">Rekod Koku</button>
                        <button onclick="showAnalysisView('class')" class="analysis-tab flex-1 py-1.5 rounded-md text-xs font-bold transition-all text-slate-500 hover:bg-white/50" id="btn-an-class">Analisis Kelas</button>
                        <button onclick="showAnalysisView('student')" class="analysis-tab flex-1 py-1.5 rounded-md text-xs font-bold transition-all text-slate-500 hover:bg-white/50" id="btn-an-student">Analisis Individu</button>
                        <button onclick="showAnalysisView('monthly')" class="analysis-tab flex-1 py-1.5 rounded-md text-xs font-bold transition-all text-slate-500 hover:bg-white/50" id="btn-an-monthly">Analisis Bulanan</button>
                    </div>

                    <!-- VIEW: Daily Records -->
                    <div id="an-view-daily">
                        <div class="bg-white rounded-xl shadow p-4 mb-6 flex flex-wrap gap-4 items-end border border-slate-100">
                            <div><label class="block text-xs font-bold text-slate-500 uppercase mb-1">Tarikh</label><input type="date" id="historyDate" class="p-2 border rounded-lg text-sm"></div>
                            <div class="w-48"><label class="block text-xs font-bold text-slate-500 uppercase mb-1">Kelas</label><select id="historyClassSelect" class="w-full p-2 border rounded-lg text-sm bg-white"><option value="">Semua Kelas</option></select></div>
                            <button onclick="loadHistory()" class="bg-blue-600 text-white px-4 py-2 rounded-lg text-sm font-bold hover:bg-blue-700 shadow-md">Cari</button>
                            <div class="flex gap-2 ml-auto">
                                <button onclick="copyWhatsappReport()" class="bg-green-500 text-white px-4 py-2 rounded-lg text-sm font-bold hover:bg-green-600 flex items-center gap-2 shadow-md" title="Salin ke Clipboard"><i class="fa-brands fa-whatsapp"></i> Salin (WA)</button>
                                <button onclick="generateAndSendTelegramReport(true)" class="bg-sky-500 text-white px-4 py-2 rounded-lg text-sm font-bold hover:bg-sky-600 flex items-center gap-2 shadow-md"><i class="fa-brands fa-telegram"></i> Hantar Laporan</button>
                            </div>
                        </div>
                        <div class="bg-white rounded-xl shadow overflow-hidden"><table class="w-full text-sm text-left"><thead class="bg-slate-50 border-b text-slate-500 uppercase text-xs"><tr><th class="px-6 py-3">Tarikh</th><th class="px-6 py-3">Nama Murid</th><th class="px-6 py-3">Info</th><th class="px-6 py-3">Status</th><th class="px-6 py-3">Dicatat Oleh</th><th class="px-6 py-3 text-right">Aksi</th></tr></thead><tbody id="historyTableBody"></tbody></table></div>
                    </div>

                    <!-- VIEW: Koku Records (NEW) -->
                    <div id="an-view-koku" class="hidden space-y-4">
                        <div class="bg-white p-4 rounded-xl shadow flex flex-wrap gap-4 items-end">
                             <!-- Toggle Report Type -->
                             <div>
                                 <label class="block text-xs font-bold text-slate-500 uppercase mb-1">Jenis</label>
                                 <select id="kokuReportType" onchange="toggleKokuInputs()" class="p-2 border rounded-lg text-sm bg-white w-full min-w-[100px]">
                                     <option value="daily">Harian</option>
                                     <option value="monthly">Bulanan</option>
                                 </select>
                             </div>

                             <!-- Date/Month Inputs -->
                             <div id="kokuDailyInputWrapper">
                                 <label class="block text-xs font-bold text-slate-500 uppercase mb-1">Tarikh</label>
                                 <input type="date" id="kokuHistDate" class="p-2 border rounded-lg text-sm">
                             </div>
                             <div id="kokuMonthlyInputWrapper" class="hidden">
                                 <label class="block text-xs font-bold text-slate-500 uppercase mb-1">Bulan</label>
                                 <input type="month" id="kokuHistMonth" class="p-2 border rounded-lg text-sm">
                             </div>

                             <div class="w-40"><label class="block text-xs font-bold text-slate-500 uppercase mb-1">Kategori</label><select id="kokuHistCat" onchange="loadKokuHistUnits()" class="p-2 border rounded-lg text-sm w-full bg-white"><option value="">Semua</option><option value="unit_beruniform">Unit Beruniform</option><option value="kelab_persatuan">Kelab</option><option value="sukan_permainan">Sukan</option></select></div>
                             <div class="w-40"><label class="block text-xs font-bold text-slate-500 uppercase mb-1">Unit</label><select id="kokuHistUnit" class="p-2 border rounded-lg text-sm w-full bg-white" disabled><option value="">Pilih Unit</option></select></div>
                             
                             <div class="flex gap-2 ml-auto">
                                <button onclick="loadKokuHistory()" class="bg-blue-600 text-white px-4 py-2 rounded-lg text-sm font-bold hover:bg-blue-700">Cari</button>
                                <button onclick="sendKokuTelegramReport()" class="bg-sky-500 text-white px-4 py-2 rounded-lg text-sm font-bold hover:bg-sky-600 flex items-center gap-2"><i class="fa-brands fa-telegram"></i> Laporan</button>
                                <button onclick="downloadPDF('koku')" class="bg-red-500 text-white px-4 py-2 rounded-lg text-sm font-bold hover:bg-red-600 flex items-center gap-2"><i class="fa-solid fa-file-pdf"></i> PDF</button>
                                <button onclick="downloadExcel('koku')" class="bg-green-600 text-white px-4 py-2 rounded-lg text-sm font-bold hover:bg-green-700 flex items-center gap-2"><i class="fa-solid fa-file-excel"></i> Excel</button>
                             </div>
                        </div>
                        <div class="bg-white rounded-xl shadow overflow-hidden overflow-x-auto">
                            <table id="tableKokuHistory" class="w-full text-sm text-left">
                                <thead id="kokuTableHead" class="bg-slate-50 border-b text-slate-500 uppercase text-xs">
                                    <!-- Header will be set by JS -->
                                </thead>
                                <tbody id="kokuHistoryBody"></tbody>
                            </table>
                        </div>
                    </div>
                    
                    <!-- VIEW: Class Analysis -->
                    <div id="an-view-class" class="hidden space-y-4">
                        <div class="bg-white p-4 rounded-xl shadow flex flex-wrap items-end gap-4">
                             <div class="w-full md:w-auto"><label class="block text-xs font-bold text-slate-500 uppercase mb-1">Tarikh</label><input type="date" id="anClassDate" class="p-2 border rounded-lg text-sm w-full"></div>
                             <button onclick="analyzeClass()" class="bg-indigo-600 text-white px-4 py-2 rounded-lg text-sm font-bold hover:bg-indigo-700">Analisis</button>
                             <div class="flex gap-2 ml-auto"><button onclick="downloadPDF('class')" class="bg-red-500 text-white px-3 py-2 rounded text-xs font-bold hover:bg-red-600">PDF</button><button onclick="downloadExcel('class')" class="bg-green-600 text-white px-3 py-2 rounded text-xs font-bold hover:bg-green-700">Excel</button></div>
                        </div>
                        <div class="bg-white rounded-xl shadow overflow-hidden"><table class="w-full text-sm text-left" id="tableAnClass"><thead class="bg-slate-50 border-b text-slate-500 uppercase text-xs"><tr><th class="px-6 py-3">Kelas</th><th class="px-6 py-3 text-center">Jum. Murid</th><th class="px-6 py-3 text-center">Hadir</th><th class="px-6 py-3 text-center">Tidak Hadir</th><th class="px-6 py-3 text-center">Peratus</th><th class="px-6 py-3 text-center">Status</th></tr></thead><tbody id="anClassBody"><tr><td colspan="6" class="p-4 text-center text-slate-400">Pilih tarikh untuk mula analisis</td></tr></tbody></table></div>
                    </div>
                    
                    <!-- VIEW: Student Analysis -->
                    <div id="an-view-student" class="hidden space-y-4">
                        <div class="bg-white p-4 rounded-xl shadow flex flex-wrap items-end gap-4">
                            <div class="w-48"><label class="block text-xs font-bold text-slate-500 uppercase mb-1">Kelas</label><select id="anStudClass" onchange="loadStudentDropdown()" class="p-2 border rounded-lg text-sm w-full bg-white"><option value="">Pilih Kelas...</option></select></div>
                            <div class="w-full md:w-64"><label class="block text-xs font-bold text-slate-500 uppercase mb-1">Nama Murid</label><select id="anStudSelect" class="p-2 border rounded-lg text-sm w-full bg-white" disabled><option value="">Pilih Murid...</option></select></div>
                            <div class="w-40"><label class="block text-xs font-bold text-slate-500 uppercase mb-1">Bulan</label><input type="month" id="anStudMonth" class="p-2 border rounded-lg text-sm w-full"></div>
                            <button onclick="analyzeStudent()" class="bg-indigo-600 text-white px-4 py-2 rounded-lg text-sm font-bold hover:bg-indigo-700">Analisis</button>
                            <div class="flex gap-2 ml-auto"><button onclick="downloadPDF('student')" class="bg-red-500 text-white px-3 py-2 rounded text-xs font-bold hover:bg-red-600">PDF</button><button onclick="downloadExcel('student')" class="bg-green-600 text-white px-3 py-2 rounded text-xs font-bold hover:bg-green-700">Excel</button></div>
                       </div>
                        <div id="anStudResult" class="hidden bg-white rounded-xl shadow p-6"><h4 class="font-bold text-lg mb-2" id="anStudTitle">Nama Murid</h4><input type="hidden" id="anStudHiddenDetails"><div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-6"><div class="bg-slate-50 p-3 rounded border"><p class="text-xs text-slate-500">Hari Persekolahan</p><p class="text-xl font-bold" id="anStudTotal">0</p></div><div class="bg-green-50 p-3 rounded border border-green-100"><p class="text-xs text-green-600">Hadir</p><p class="text-xl font-bold text-green-700" id="anStudPresent">0</p></div><div class="bg-red-50 p-3 rounded border border-red-100"><p class="text-xs text-red-600">Tidak Hadir</p><p class="text-xl font-bold text-red-700" id="anStudAbsent">0</p></div><div class="bg-blue-50 p-3 rounded border border-blue-100"><p class="text-xs text-blue-600">Peratus</p><p class="text-xl font-bold text-blue-700" id="anStudPct">0%</p></div></div><h5 class="font-bold text-sm border-b pb-2 mb-2">Senarai Tarikh Tidak Hadir</h5><ul class="list-disc pl-5 text-sm text-red-600" id="anStudAbsentList"></ul></div>
                    </div>

                     <!-- VIEW: Monthly Analysis -->
                     <div id="an-view-monthly" class="hidden space-y-4">
                        <div class="bg-white p-4 rounded-xl shadow flex items-end gap-4">
                             <div class="w-full md:w-auto"><label class="block text-xs font-bold text-slate-500 uppercase mb-1">Bulan</label><input type="month" id="anMonthInput" class="p-2 border rounded-lg text-sm w-full"></div>
                             <button onclick="analyzeMonthly()" class="bg-indigo-600 text-white px-4 py-2 rounded-lg text-sm font-bold hover:bg-indigo-700">Analisis</button>
                             <div class="flex gap-2 ml-auto"><button onclick="downloadPDF('monthly')" class="bg-red-500 text-white px-3 py-2 rounded text-xs font-bold hover:bg-red-600">PDF</button><button onclick="downloadExcel('monthly')" class="bg-green-600 text-white px-3 py-2 rounded text-xs font-bold hover:bg-green-700">Excel</button></div>
                        </div>
                        <div class="bg-white rounded-xl shadow overflow-hidden"><table class="w-full text-sm text-left" id="tableAnMonth"><thead class="bg-slate-50 border-b text-slate-500 uppercase text-xs"><tr><th class="px-6 py-3">Kelas</th><th class="px-6 py-3 text-center">Purata Kehadiran</th><th class="px-6 py-3">Trend Harian (Ringkas)</th></tr></thead><tbody id="anMonthBody"><tr><td colspan="3" class="p-4 text-center text-slate-400">Pilih bulan untuk analisis</td></tr></tbody></table></div>
                    </div>

                    <!-- ZON BAHAYA (DATA RESET) -->
                    <div class="mt-8 p-4 bg-red-50 border border-red-200 rounded-xl">
                        <h4 class="font-bold text-red-700 text-sm mb-2"><i class="fa-solid fa-triangle-exclamation"></i> Zon Bahaya (Pengurusan Data)</h4>
                        <div class="flex flex-wrap gap-4">
                            <div class="flex-1 min-w-[200px]">
                                <p class="text-xs text-red-600 mb-2">Padam semua rekod kehadiran (Kelas & Koku).</p>
                                <button onclick="confirmDeleteAll('attendance')" class="bg-white border border-red-300 text-red-600 hover:bg-red-600 hover:text-white px-4 py-2 rounded-lg text-xs font-bold transition-colors w-full">
                                    Reset Semua Laporan
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </main>

        <!-- MODAL -->
        <div id="confirmModal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-[60]"><div class="bg-white p-6 rounded-lg shadow-xl max-w-sm w-full"><div class="flex items-center justify-center w-12 h-12 mx-auto mb-4 bg-red-100 rounded-full"><i class="fa-solid fa-triangle-exclamation text-red-600 text-xl"></i></div><h3 class="text-lg font-bold text-center text-slate-800 mb-2" id="confirmTitle">Padam Data?</h3><p class="text-sm text-center text-slate-500 mb-6" id="confirmDesc">Tindakan ini tidak boleh dikembalikan. Anda pasti?</p><div class="flex gap-3 justify-center"><button onclick="closeConfirm()" class="px-4 py-2 text-slate-600 bg-slate-100 hover:bg-slate-200 rounded-lg text-sm font-medium transition-colors">Batal</button><button id="btnConfirmYes" class="px-4 py-2 text-white bg-red-600 hover:bg-red-700 rounded-lg text-sm font-medium shadow-md shadow-red-200 transition-colors">Ya, Padam</button></div></div></div>
        <div id="toast-container" class="fixed bottom-4 right-4 flex flex-col gap-2 z-50"></div>
    </div>

    <script>
        // INIT
        const firebaseConfig = { apiKey: "AIzaSyDwovSIef6DJotjk-jNwwytHze-kwyjcJs", authDomain: "ekehadiran-1766f.firebaseapp.com", projectId: "ekehadiran-1766f", storageBucket: "ekehadiran-1766f.firebasestorage.app", messagingSenderId: "860711914424", appId: "1:860711914424:web:0008b76a3bfdb942761d4d", measurementId: "G-QH45P38D7X" };
        const app = firebase.initializeApp(firebaseConfig); const auth = firebase.auth(); const db = firebase.firestore(app);
        let currentUser = null, currentStudents = [], telegramToken = '', telegramChatId = '', attType = 'class', classListCache = [];
        let allStudentsData = []; // Store all students for filtering

        function escapeHtml(text) { if (!text) return text; return text.replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;").replace(/"/g, "&quot;"); }
        function escapeQuote(text) { if(!text) return ""; return text.replace(/'/g, "\\'"); }
        function getShortName(name) { if (!name) return ""; const words = name.trim().split(/\s+/); return words.slice(0, 2).join(" "); }
        function showToast(m,t="success") { const c=document.getElementById('toast-container'), d=document.createElement('div'); d.className=`${t==='error'?'bg-red-500':'bg-emerald-500'} text-white px-4 py-3 rounded shadow-lg flex items-center gap-3 min-w-[250px] text-sm transform transition-all duration-300 translate-y-10 opacity-0`; d.innerHTML=`<span>${m}</span>`; c.appendChild(d); requestAnimationFrame(()=>d.classList.remove('translate-y-10','opacity-0')); setTimeout(()=>{d.classList.add('translate-y-10','opacity-0');setTimeout(()=>d.remove(),300);},3000); }

        auth.onAuthStateChanged(u => { if(!u) auth.signInAnonymously(); initializeApp(); });
        async function initializeApp() {
            try { const doc = await db.collection('settings').doc('telegram_config').get(); if (doc.exists) { const d = doc.data(); telegramToken = d.bot_token || ''; telegramChatId = d.chat_id || ''; } } catch (e) {}
            document.getElementById('tgBotToken').value = telegramToken; document.getElementById('tgChatId').value = telegramChatId;
            const today = new Date(); document.getElementById('attendanceDate').valueAsDate = today; document.getElementById('autoKokuDate').valueAsDate = today;
            document.getElementById('landingDateDisplay').innerText = today.toLocaleDateString('ms-MY', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' });
            checkTuesday(); loadLandingStats();
            
            // Set default views
            document.getElementById('kokuHistDate').valueAsDate = today;
            const ym = today.toISOString().slice(0,7);
            document.getElementById('kokuHistMonth').value = ym;
            
            try { const aC = await db.collection('admins').limit(1).get(); if(aC.empty) await db.collection('admins').add({username:'admin', password:'password'}); const tC = await db.collection('teachers').limit(1).get(); if(tC.empty) await db.collection('teachers').add({nama:'Cikgu Aisyah', ic_akhir4:'1234', role:'admin'}); } catch(e){}
        }

        // KOKU FUNCTIONS
        window.toggleKokuInputs = () => {
            const type = document.getElementById('kokuReportType').value;
            const dailyDiv = document.getElementById('kokuDailyInputWrapper');
            const monthlyDiv = document.getElementById('kokuMonthlyInputWrapper');
            if (type === 'monthly') {
                dailyDiv.classList.add('hidden');
                monthlyDiv.classList.remove('hidden');
            } else {
                dailyDiv.classList.remove('hidden');
                monthlyDiv.classList.add('hidden');
            }
        };

        window.loadKokuHistory = async () => {
            const type = document.getElementById('kokuReportType').value;
            const cat = document.getElementById('kokuHistCat').value;
            const unit = document.getElementById('kokuHistUnit').value;
            
            const tbHead = document.getElementById('kokuTableHead');
            const tbBody = document.getElementById('kokuHistoryBody');
            tbBody.innerHTML = '<tr><td colspan="6" class="p-4 text-center">Mencari...</td></tr>';

            try {
                let query = db.collection('attendance').where('type', '==', 'koku');
                
                if (type === 'daily') {
                    // DAILY REPORT LOGIC
                    const dateStr = document.getElementById('kokuHistDate').value;
                    if(!dateStr) return showToast("Pilih Tarikh", "error");
                    query = query.where('date', '==', dateStr);
                    if (unit) query = query.where('class_name', '==', unit);

                    // Render Header
                    tbHead.innerHTML = `<tr>
                        <th class="px-6 py-3">Tarikh</th>
                        <th class="px-6 py-3">Nama Murid</th>
                        <th class="px-6 py-3">Unit</th>
                        <th class="px-6 py-3">Info</th>
                        <th class="px-6 py-3">Status</th>
                        <th class="px-6 py-3 text-right">Aksi</th>
                    </tr>`;

                    const snap = await query.get();
                    tbBody.innerHTML = '';
                    if (snap.empty) return tbBody.innerHTML = '<tr><td colspan="6" class="p-4 text-center text-slate-400">Tiada rekod</td></tr>';
                    
                    snap.forEach(doc => {
                        const r = doc.data();
                        
                        // Dynamic Status Badge
                        const statusBadge = r.status === 'Hadir' 
                            ? '<span class="bg-green-100 text-green-700 px-2 rounded text-xs">Hadir</span>' 
                            : '<span class="bg-red-100 text-red-700 px-2 rounded text-xs">Tidak Hadir</span>';
                        
                        tbBody.innerHTML += `<tr class="bg-white border-b">
                            <td class="px-6 py-4 text-xs">${r.date}</td>
                            <td class="px-6 py-4">${r.student_name}</td>
                            <td class="px-6 py-4 font-bold text-xs">${r.class_name}</td>
                            <td class="px-6 py-4 text-xs">${r.extra_info||'-'}</td>
                            <td class="px-6 py-4">${statusBadge}</td>
                            <td class="px-6 py-4 text-right"><button onclick="confirmDelete('attendance','${doc.id}')" class="text-red-600 hover:underline text-xs">Padam</button></td>
                        </tr>`;
                    });

                } else {
                    // MONTHLY REPORT LOGIC
                    const monthStr = document.getElementById('kokuHistMonth').value; // YYYY-MM
                    if(!monthStr) return showToast("Pilih Bulan", "error");
                    
                    const startDate = monthStr + "-01";
                    const endDate = monthStr + "-31"; // Simple upper bound
                    
                    query = query.where('date', '>=', startDate).where('date', '<=', endDate);
                    if (unit) query = query.where('class_name', '==', unit);

                    const sSnap = await db.collection('students').get();
                    const unitMembers = {}; 
                    
                    sSnap.forEach(doc => {
                        const s = doc.data();
                        ['unit_beruniform', 'kelab_persatuan', 'sukan_permainan'].forEach(field => {
                            if(s[field]) {
                                const uName = s[field].trim();
                                if(!unitMembers[uName]) unitMembers[uName] = new Set();
                                unitMembers[uName].add(s.nama);
                            }
                        });
                    });

                    const attSnap = await query.get();
                    
                    const grouped = {};
                    attSnap.forEach(doc => {
                        const r = doc.data();
                        
                        const key = `${r.date}__${r.class_name}`;
                        if (!grouped[key]) grouped[key] = { date: r.date, unit: r.class_name, present: new Set() };
                        
                        if (r.status === 'Hadir') {
                            grouped[key].present.add(r.student_name);
                        }
                    });

                    // Render Header
                    tbHead.innerHTML = `<tr>
                        <th class="px-6 py-3">Tarikh</th>
                        <th class="px-6 py-3">Unit</th>
                        <th class="px-6 py-3">Senarai Hadir</th>
                        <th class="px-6 py-3">Senarai Tidak Hadir</th>
                    </tr>`;

                    tbBody.innerHTML = '';
                    const keys = Object.keys(grouped).sort();
                    if (keys.length === 0) return tbBody.innerHTML = '<tr><td colspan="4" class="p-4 text-center text-slate-400">Tiada rekod</td></tr>';

                    keys.forEach(k => {
                        const g = grouped[k];
                        const allMembers = unitMembers[g.unit] || new Set();
                        const absentList = Array.from(allMembers).filter(n => !g.present.has(n)).sort();
                        const presentList = Array.from(g.present).sort();

                        tbBody.innerHTML += `<tr class="bg-white border-b hover:bg-slate-50">
                            <td class="px-6 py-4 text-xs font-bold whitespace-nowrap align-top">${g.date}</td>
                            <td class="px-6 py-4 text-xs font-bold text-blue-600 align-top">${g.unit}</td>
                            <td class="px-6 py-4 text-xs align-top">
                                <div class="max-h-32 overflow-y-auto custom-scrollbar">
                                    <span class="font-bold text-green-600 mb-1 block">Hadir (${presentList.length})</span>
                                    ${presentList.join(', ')}
                                </div>
                            </td>
                            <td class="px-6 py-4 text-xs align-top">
                                <div class="max-h-32 overflow-y-auto custom-scrollbar">
                                    <span class="font-bold text-red-600 mb-1 block">Tidak Hadir (${absentList.length})</span>
                                    <span class="text-slate-500">${absentList.length > 0 ? absentList.join(', ') : '-'}</span>
                                </div>
                            </td>
                        </tr>`;
                    });
                }
            } catch(e) {
                console.error(e);
                tbBody.innerHTML = '<tr><td colspan="6" class="p-4 text-center text-red-500">Ralat mengambil data.</td></tr>';
            }
        };

        // AUTO KOKU LOGIC
        window.runAutoKoku = async () => {
            const d = document.getElementById('autoKokuDate').value;
            const cat = document.getElementById('autoKokuCategory').value;
            const week = document.getElementById('autoKokuWeek').value;
            if (!d || !cat || !week) return showToast("Sila isi semua maklumat", "error");
            
            const btn = document.getElementById('btnAutoKoku'); btn.classList.add('btn-loading');
            try {
                // 1. Get Morning Attendance (Hadir Only)
                const amSnap = await db.collection('attendance').where('date', '==', d).where('type', '==', 'class').where('status','==','Hadir').get();
                if (amSnap.empty) { btn.classList.remove('btn-loading'); return showToast("Tiada kehadiran pagi dijumpai", "error"); }
                
                // 2. Get Students for mapping units
                const sSnap = await db.collection('students').get();
                const sMap = {}; sSnap.forEach(doc => sMap[doc.id] = doc.data());

                const batchSize = 400; let batch = db.batch(), count = 0;
                
                for (const doc of amSnap.docs) {
                    const att = doc.data();
                    const student = sMap[att.student_id];
                    if (student && student[cat]) { // Check if student has assigned unit in that category
                        const unitName = student[cat].trim();
                        if (unitName) {
                            const ref = db.collection('attendance').doc(`${d}_${unitName.replace(/\s/g,'')}_${att.student_id}_koku`);
                            batch.set(ref, {
                                date: d,
                                class_name: unitName,
                                student_id: att.student_id,
                                student_name: att.student_name,
                                status: 'Hadir',
                                teacher_name: "Auto (Admin)",
                                teacher_id: currentUser.id,
                                type: 'koku',
                                extra_info: "Minggu: " + week,
                                timestamp: firebase.firestore.FieldValue.serverTimestamp()
                            });
                            count++;
                            if (count % batchSize === 0) { await batch.commit(); batch = db.batch(); }
                        }
                    }
                }
                if (count % batchSize !== 0) await batch.commit();
                showToast(`${count} rekod koku dijana.`);
            } catch(e) { console.error(e); showToast("Ralat sistem", "error"); }
            btn.classList.remove('btn-loading');
        };

        // KOKU HISTORY LOGIC
        window.loadKokuHistUnits = async () => {
            const cat = document.getElementById('kokuHistCat').value;
            const sel = document.getElementById('kokuHistUnit'); sel.innerHTML = '<option value="">Semua Unit</option>';
            if (cat) {
                 const sSnap = await db.collection('students').get(); const units = new Set();
                 sSnap.forEach(d => { const val = d.data()[cat]; if(val) units.add(val.trim()); });
                 Array.from(units).sort().forEach(u => { const o = document.createElement('option'); o.value = u; o.text = u; sel.appendChild(o); });
                 sel.disabled = false;
            } else sel.disabled = true;
        };

        // Standard Functions
        window.checkTuesday=()=>{ const d=new Date(document.getElementById('attendanceDate').value); const isT=d.getDay()===2; const tc=document.getElementById('attTypeContainer'); if(isT)tc.classList.remove('hidden'); else {tc.classList.add('hidden');setAttType('class');}};
        window.setAttType=(t)=>{ attType=t; const bc=document.getElementById('btnTypeClass'), bk=document.getElementById('btnTypeKoku'), fc=document.getElementById('filterClassContainer'), fk=document.getElementById('filterKokuContainer'), lt=document.getElementById('attListTitle'); if(t==='class'){bc.classList.add('bg-white','shadow','text-blue-600');bc.classList.remove('text-slate-500','hover:bg-white');bk.classList.remove('bg-white','shadow','text-blue-600');bk.classList.add('text-slate-500','hover:bg-white');fc.classList.remove('hidden');fk.classList.add('hidden');lt.innerText="Senarai Kehadiran Kelas";}else{bk.classList.add('bg-white','shadow','text-blue-600');bk.classList.remove('text-slate-500','hover:bg-white');bc.classList.remove('bg-white','shadow','text-blue-600');bc.classList.add('text-slate-500','hover:bg-white');fc.classList.add('hidden');fk.classList.remove('hidden');lt.innerText="Senarai Kehadiran Kokurikulum";} document.getElementById('attendanceTableBody').innerHTML='';document.getElementById('emptyState').classList.remove('hidden'); };
        window.loadKokuUnits=async()=>{const c=document.getElementById('kokuCategory').value,s=document.getElementById('kokuUnitSelect');s.innerHTML='<option value="">Memuatkan...</option>';s.disabled=true;if(!c){s.innerHTML='<option value="">Pilih Unit...</option>';return;}try{const sn=await db.collection('students').get();const u=new Set();sn.forEach(d=>{const da=d.data();let v=c==='unit_beruniform'?da.unit_beruniform:(c==='kelab_persatuan'?da.kelab_persatuan:da.sukan_permainan);if(v)u.add(v.trim());});s.innerHTML='<option value="">Pilih Unit...</option>';Array.from(u).sort().forEach(x=>{const o=document.createElement('option');o.value=x;o.text=x;s.appendChild(o);});s.disabled=false;}catch(e){showToast("Ralat","error");}};
        window.loadStudentsForAttendance=async()=>{document.getElementById('attendanceWorkspace').classList.remove('hidden');const tb=document.getElementById('attendanceTableBody');tb.innerHTML='<tr><td colspan="4" class="text-center">Memuatkan...</td></tr>';let fVal;if(attType==='class'){fVal=document.getElementById('teacherClassSelect').value;if(!fVal)return;document.getElementById('classNameDisplay').innerText=fVal;const s=await db.collection('students').where('kelas','==',fVal).get();currentStudents=[];s.forEach(d=>currentStudents.push({id:d.id,...d.data(),status:'Hadir'}));}else{const cat=document.getElementById('kokuCategory').value;fVal=document.getElementById('kokuUnitSelect').value;if(!cat||!fVal)return;document.getElementById('classNameDisplay').innerText=fVal;let field=cat==='unit_beruniform'?'unit_beruniform':(cat==='kelab_persatuan'?'kelab_persatuan':'sukan_permainan');const s=await db.collection('students').where(field,'==',fVal).get();currentStudents=[];s.forEach(d=>currentStudents.push({id:d.id,...d.data(),status:'Hadir'}));}currentStudents.sort((a,b)=>a.nama.localeCompare(b.nama));if(!currentStudents.length){document.getElementById('emptyState').classList.remove('hidden');tb.innerHTML='';}else{document.getElementById('emptyState').classList.add('hidden');const d=document.getElementById('attendanceDate').value;let query=db.collection('attendance').where('date','==',d).where('class_name','==',fVal);const p=await query.get();const m={};p.forEach(r=>m[r.data().student_id]=r.data().status);renderAttTable(m);}};
        function renderAttTable(m={}) { const tb = document.getElementById('attendanceTableBody'); tb.innerHTML=''; currentStudents.forEach((s,i)=>{ s.status = m[s.id]||'Hadir'; let info = attType === 'class' ? (s.rmt === 'Ya' ? 'RMT' : '-') : s.kelas; tb.innerHTML += `<tr class="bg-white border-b"><td class="px-6 py-4 font-mono text-xs">${i+1}</td><td class="px-6 py-4 font-medium">${s.nama}</td><td class="px-6 py-4 text-xs text-slate-500">${info}</td><td class="px-6 py-4 text-center"><label class="inline-flex items-center cursor-pointer"><input type="checkbox" class="sr-only peer" onchange="toggleAtt('${s.id}',this)" ${s.status==='Hadir'?'checked':''}><div class="w-11 h-6 bg-gray-200 peer-focus:ring-4 peer-focus:ring-blue-300 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-blue-600"></div></label></td></tr>`; }); updSum(); }
        window.toggleAtt=(id,b)=>{ const s=currentStudents.find(x=>x.id===id); if(s){s.status=b.checked?'Hadir':'Tidak Hadir';updSum();} };
        function updSum(){ const t=currentStudents.length, p=currentStudents.filter(s=>s.status==='Hadir').length, a=t-p, pct=t?Math.round((p/t)*100):0; document.getElementById('summaryTotal').innerText=t; document.getElementById('summaryPresent').innerText=p; document.getElementById('summaryAbsent').innerText=a; document.getElementById('summaryPercentText').innerText=pct+'%'; document.getElementById('summaryProgressBar').style.width=pct+'%'; }
        window.submitAttendance = async () => { const btn=document.getElementById('btnSubmitAttendance'); btn.classList.add('btn-loading'); const d=document.getElementById('attendanceDate').value; let gn = "", tp = attType, ei = ""; if (attType === 'class') gn = document.getElementById('teacherClassSelect').value; else { gn = document.getElementById('kokuUnitSelect').value; ei = "Minggu: " + document.getElementById('kokuWeek').value; } if(!d || !gn) { btn.classList.remove('btn-loading'); return showToast("Pilih semua maklumat", "error"); } const tn = currentUser && currentUser.nama ? currentUser.nama : "Guru Bertugas"; const ps = currentStudents.map(s => { const docId = `${d}_${gn.replace(/\s/g,'')}_${s.id}_${tp}`; return db.collection('attendance').doc(docId).set({ date:d, class_name: gn, student_id:s.id, student_name:s.nama, status:s.status, teacher_id:currentUser.id, teacher_name:tn, type: tp, extra_info: ei, timestamp:firebase.firestore.FieldValue.serverTimestamp() }); }); await Promise.all(ps); await generateAndSendTelegramReport(false, tp, gn, d); btn.classList.remove('btn-loading'); showToast("Berjaya Disimpan"); };

        window.generateAndSendTelegramReport = async (toast=true, type='class', groupName='', overrideDate=null) => {
            if(!telegramToken || !telegramChatId) { if(toast) showToast("Sila set Token","error"); return; }
            
            // Logic selection of Date
            let dateStr = overrideDate;
            if (!dateStr) {
                if (!document.getElementById('view-admin-dashboard').classList.contains('hidden')) {
                     dateStr = document.getElementById('historyDate').value;
                } else {
                     dateStr = document.getElementById('attendanceDate').value;
                }
            }
            
            if(!dateStr) { if(toast) showToast("Pilih Tarikh","error"); return; }

            const dateObj = new Date(dateStr);
            const days = ['AHAD','ISNIN','SELASA','RABU','KHAMIS','JUMAAT','SABTU'];
            const day = String(dateObj.getUTCDate()).padStart(2,'0');
            const month = String(dateObj.getUTCMonth()+1).padStart(2,'0');
            const year = dateObj.getUTCFullYear();
            const fDate = `${day}/${month}/${year}`;

            if(toast) showToast("Menjana...", "info");

            try {
                const sSnap = await db.collection('students').get();
                const classMap = {}; 
                const stRmt = {}; 
                let gRmtTotal = 0; 
                let gTotal = 0;

                sSnap.forEach(d => {
                    const dat = d.data();
                    const c = dat.kelas;
                    if (c) {
                        if (!classMap[c]) classMap[c] = 0;
                        classMap[c]++;
                        gTotal++;
                        
                        if (dat.rmt && (dat.rmt === 'Ya' || dat.rmt.trim().toLowerCase() === 'ya')) {
                            stRmt[d.id] = true;
                            gRmtTotal++;
                        }
                    }
                });

                const sortedClasses = Object.keys(classMap).sort();
                const reportType = type || 'class';
                const aSnap = await db.collection('attendance')
                    .where('date', '==', dateStr)
                    .where('type', '==', reportType) 
                    .get();

                const attData = {}; 
                let gPres = 0; 
                let gRmtPres = 0; 

                aSnap.forEach(d => {
                    const r = d.data();
                    const c = r.class_name;
                    
                    if (!attData[c]) attData[c] = { p: 0, abs: [] };
                    
                    if (r.status === 'Hadir') {
                        attData[c].p++;
                        gPres++;
                        if (stRmt[r.student_id]) gRmtPres++;
                    } else {
                        attData[c].abs.push(r.student_name);
                    }
                });

                const ovPct = gTotal > 0 ? Math.round((gPres / gTotal) * 100) : 0;
                let lines = [];

                sortedClasses.forEach(c => {
                    if (attData[c]) {
                        const p = attData[c].p;
                        const t = classMap[c];
                        const pct = Math.round((p / t) * 100);
                        const abs = attData[c].abs.length > 0 
                            ? ` ${attData[c].abs.map(n => escapeHtml(getShortName(n).toUpperCase())).join(', ')}` 
                            : '';
                        lines.push(`${escapeHtml(c)}- ${p}/${t} (${pct}%)  ${abs}`);
                    } else {
                        lines.push(`⚠️ ${escapeHtml(c)}`);
                    }
                });

                const headerLine = `${days[dateObj.getUTCDay()]} (${gPres}/${gTotal}) (${ovPct}%) . RMT: ${gRmtPres}/${gRmtTotal}`;
                const msg = `<b>${headerLine}</b>\n${fDate}\n\n${lines.join('\n')}`;

                await fetch(`https://api.telegram.org/bot${telegramToken}/sendMessage`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ chat_id: telegramChatId, text: msg, parse_mode: 'HTML' })
                });

                if (toast) showToast("Laporan Penuh dihantar");
                
            } catch (e) {
                console.error(e);
                if (toast) showToast("Gagal", "error");
            }
        };

        window.sendKokuTelegramReport = async () => {
            if(!telegramToken || !telegramChatId) return showToast("Sila set Token", "error");
            const dateStr = document.getElementById('kokuHistDate').value;
            if(!dateStr) return showToast("Pilih Tarikh", "error");

            const selectedCat = document.getElementById('kokuHistCat').value;
            const selectedUnit = document.getElementById('kokuHistUnit').value;

            showToast("Menjana...", "info");

            try {
                const sSnap = await db.collection('students').get();
                const aSnapQuery = db.collection('attendance').where('date', '==', dateStr).where('type', '==', 'koku');
                const aSnap = await (selectedUnit ? aSnapQuery.where('class_name', '==', selectedUnit) : aSnapQuery).get();

                const unitStats = {}; 
                const getStatObj = () => ({ total: 0, present: 0, absents: [] });

                sSnap.forEach(doc => {
                    const s = doc.data();
                    const unitsToCheck = [];
                    if (selectedUnit) {
                        if (s.unit_beruniform === selectedUnit || s.kelab_persatuan === selectedUnit || s.sukan_permainan === selectedUnit) {
                            unitsToCheck.push(selectedUnit);
                        }
                    } else if (selectedCat) {
                        if (s[selectedCat]) unitsToCheck.push(s[selectedCat]);
                    } else {
                        if (s.unit_beruniform) unitsToCheck.push(s.unit_beruniform);
                        if (s.kelab_persatuan) unitsToCheck.push(s.kelab_persatuan);
                        if (s.sukan_permainan) unitsToCheck.push(s.sukan_permainan);
                    }

                    unitsToCheck.forEach(u => {
                        const unitName = u.trim();
                        if (!unitName) return;
                        if (!unitStats[unitName]) unitStats[unitName] = getStatObj();
                        unitStats[unitName].total++;
                        unitStats[unitName].absents.push(s.nama); 
                    });
                });

                const activeUnits = new Set();
                aSnap.forEach(doc => {
                    const r = doc.data();
                    const u = r.class_name;
                    activeUnits.add(u);
                    
                    if (unitStats[u]) {
                        if (r.status === 'Hadir') {
                            unitStats[u].present++;
                            unitStats[u].absents = unitStats[u].absents.filter(name => name !== r.student_name);
                        }
                    }
                });

                const dateObj = new Date(dateStr);
                const days = ['AHAD','ISNIN','SELASA','RABU','KHAMIS','JUMAAT','SABTU'];
                const dayStr = days[dateObj.getUTCDay()];
                const fDate = `${String(dateObj.getUTCDate()).padStart(2,'0')}/${String(dateObj.getUTCMonth()+1).padStart(2,'0')}/${dateObj.getUTCFullYear()}`;

                let header = `*LAPORAN KEHADIRAN KOKURIKULUM*\n${dayStr}, ${fDate}`;
                if(selectedUnit) header += `\nUnit: ${selectedUnit}`;
                else if(selectedCat) {
                    const catName = selectedCat === 'unit_beruniform' ? 'Unit Beruniform' : (selectedCat === 'kelab_persatuan' ? 'Kelab & Persatuan' : 'Sukan & Permainan');
                    header += `\nKategori: ${catName}`;
                }

                let lines = [];
                const unitsToReport = selectedUnit ? [selectedUnit] : Array.from(activeUnits);
                
                unitsToReport.sort().forEach(u => {
                    const stat = unitStats[u];
                    if (!stat) return; 
                    
                    const pct = stat.total > 0 ? Math.round((stat.present / stat.total) * 100) : 0;
                    const absentList = stat.absents.map(n => getShortName(n).toUpperCase()).join(', ');
                    
                    let line = `*${u}* - ${stat.present}/${stat.total} (${pct}%)`;
                    if (absentList) line += `\n⚠️ ${absentList}`;
                    lines.push(line);
                });

                if (lines.length === 0) return showToast("Tiada rekod untuk dilaporkan", "info");

                const msg = `${header}\n\n${lines.join('\n\n')}`;

                await fetch(`https://api.telegram.org/bot${telegramToken}/sendMessage`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ chat_id: telegramChatId, text: msg, parse_mode: 'Markdown' })
                });

                showToast("Laporan Koku Dihantar");

            } catch(e) {
                console.error(e);
                showToast("Ralat", "error");
            }
        };

        // New Function to Copy Report for WhatsApp
        window.copyWhatsappReport = async () => {
            let dateStr;
            if (!document.getElementById('view-admin-dashboard').classList.contains('hidden')) {
                 dateStr = document.getElementById('historyDate').value;
            } else {
                 dateStr = document.getElementById('attendanceDate').value;
            }
            
            if(!dateStr) { showToast("Pilih Tarikh","error"); return; } 
            
            const dateObj = new Date(dateStr); 
            const days = ['AHAD','ISNIN','SELASA','RABU','KHAMIS','JUMAAT','SABTU']; 
            const day = String(dateObj.getUTCDate()).padStart(2,'0');
            const month = String(dateObj.getUTCMonth()+1).padStart(2,'0');
            const year = dateObj.getUTCFullYear();
            const fDate = `${day}/${month}/${year}`;
            
            showToast("Menjana data...", "info");
            
            try {
                const sSnap = await db.collection('students').get(); 
                const classMap={}, stRmt={}; 
                let gRmtTotal = 0; 
                let gTotal = 0;

                sSnap.forEach(d=>{ 
                    const dat=d.data(), c=dat.kelas; 
                    if(c) {
                        if(!classMap[c])classMap[c]=0; 
                        classMap[c]++; 
                        gTotal++;
                        if (dat.rmt && (dat.rmt === 'Ya' || dat.rmt.trim().toLowerCase() === 'ya')) {
                            stRmt[d.id]=true; gRmtTotal++;
                        } 
                    }
                }); 
                
                const sortedClasses = Object.keys(classMap).sort(); 
                const attTypeToUse = 'class'; 

                const aSnap = await db.collection('attendance')
                    .where('date','==',dateStr)
                    .where('type','==',attTypeToUse)
                    .get(); 
                
                const attData={}; 
                let gPres=0, gRmtPres=0; 
                
                aSnap.forEach(d=>{ 
                    const r=d.data(), c=r.class_name; 
                    if(!attData[c]) attData[c]={p:0, abs:[]}; 
                    if(r.status==='Hadir'){
                        attData[c].p++; 
                        gPres++; 
                        if(stRmt[r.student_id]) gRmtPres++;
                    } else {
                        attData[c].abs.push(r.student_name); 
                    }
                }); 
                
                const ovPct = gTotal > 0 ? Math.round((gPres/gTotal)*100) : 0; 
                let lines = []; 
                
                sortedClasses.forEach(c=>{ 
                    if(attData[c]){ 
                        const p=attData[c].p, t=classMap[c], pct=Math.round((p/t)*100);
                        const abs = attData[c].abs.length > 0 
                            ? ` ${attData[c].abs.map(n=>getShortName(n).toUpperCase()).join(', ')}` 
                            : ''; 
                        lines.push(`${c}- ${p}/${t} (${pct}%)  ${abs}`); 
                    } else {
                        lines.push(`⚠️ ${c}`); 
                    }
                }); 
                
                const headerLine = `*${days[dateObj.getUTCDay()]} (${gPres}/${gTotal}) (${ovPct}%) . RMT: ${gRmtPres}/${gRmtTotal}*`;
                const finalMsg = `${headerLine}\n${fDate}\n\n${lines.join('\n')}`;
                
                navigator.clipboard.writeText(finalMsg).then(() => {
                    showToast("Laporan disalin ke papan keratan!");
                }, () => {
                    showToast("Gagal menyalin", "error");
                });
            } catch (e) {
                console.error(e);
                showToast("Ralat menjana laporan", "error");
            }
        };

        // Updated: downloadPDF to support Koku Monthly
        window.downloadPDF = async (t) => {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            
            let title = "";
            let htmlId = "";

            if(t === 'class') {
                title = "Analisis Kehadiran Kelas";
                htmlId = '#tableAnClass';
            } else if(t === 'monthly') {
                title = "Analisis Kehadiran Bulanan";
                htmlId = '#tableAnMonth';
            } else if(t === 'koku') {
                const type = document.getElementById('kokuReportType').value;
                if(type === 'monthly') {
                     const month = document.getElementById('kokuHistMonth').value;
                     title = `Laporan Kokurikulum Bulanan (${month})`;
                } else {
                     const date = document.getElementById('kokuHistDate').value;
                     title = `Laporan Kokurikulum Harian (${date})`;
                }
                htmlId = '#tableKokuHistory';
            } else {
                const name = document.getElementById('anStudTitle').innerText;
                const present = document.getElementById('anStudPresent').innerText;
                doc.text(name, 14, 15);
                doc.text(present + " Hadir", 14, 25);
                doc.save('student.pdf');
                return;
            }

            doc.text(title, 14, 15);
            
            doc.autoTable({ 
                html: htmlId, 
                startY: 20,
                styles: { fontSize: 8 },
                theme: 'grid',
                columns: t === 'koku' ? [
                    {header: 'Tarikh', dataKey: 0},
                    {header: 'Nama Murid / Unit', dataKey: 1}, // Merged usage depending on view
                    {header: 'Unit / Info', dataKey: 2},
                    {header: 'Info / Status', dataKey: 3},
                    {header: 'Status', dataKey: 4}
                ] : undefined
            });
            
            doc.save('laporan.pdf');
        };

        // Updated: downloadExcel to support Koku Monthly
        window.downloadExcel = (t) => {
            let tableId = "";
            let fileName = `laporan_${t}.xlsx`;

            if(t === 'class') tableId = 'tableAnClass';
            else if(t === 'monthly') tableId = 'tableAnMonth';
            else if(t === 'koku') tableId = 'tableKokuHistory';
            else if(t === 'student') {
                const name = document.getElementById('anStudSelect').options[document.getElementById('anStudSelect').selectedIndex].text;
                const wb = XLSX.utils.book_new();
                const ws_data = [
                    ["Laporan Kehadiran Murid"],
                    ["Nama", name],
                    ["Hari Persekolahan", document.getElementById('anStudTotal').innerText],
                    ["Hadir", document.getElementById('anStudPresent').innerText],
                    ["Tidak Hadir", document.getElementById('anStudAbsent').innerText],
                    ["Peratus", document.getElementById('anStudPct').innerText],
                    [],
                    ["Senarai Tarikh Tidak Hadir"]
                ];
                
                const ul = document.getElementById('anStudAbsentList');
                const items = ul.getElementsByTagName('li');
                for (let item of items) {
                    ws_data.push([item.innerText]);
                }

                const ws = XLSX.utils.aoa_to_sheet(ws_data);
                XLSX.utils.book_append_sheet(wb, ws, "Laporan");
                XLSX.writeFile(wb, `Analisis_${name}.xlsx`);
                return;
            }

            // Clone table to remove 'Aksi' column for clean export
            const originalTable = document.getElementById(tableId);
            const clonedTable = originalTable.cloneNode(true);
            
            // Remove last column (Aksi) from header and body rows if present
            const rows = clonedTable.rows;
            for (let i = 0; i < rows.length; i++) {
                const cells = rows[i].cells;
                if (cells.length > 0) {
                    const lastCellIndex = cells.length - 1;
                    // Check if last header is 'Aksi' to be sure, or just remove last col
                    // For simplicity in this context, assuming last column is always action/button
                    rows[i].deleteCell(lastCellIndex);
                }
            }

            const wb = XLSX.utils.table_to_book(clonedTable, {sheet: "Sheet1"});
            XLSX.writeFile(wb, fileName);
        };

        window.saveTelegramSettings = async () => { const t = document.getElementById('tgBotToken').value, c = document.getElementById('tgChatId').value; telegramToken=t; telegramChatId=c; await db.collection('settings').doc('telegram_config').set({bot_token:t,chat_id:c}); showToast("Disimpan"); };

        // Admin & Stats
        async function loadLandingStats() { 
            const now = new Date();
            const todayStr = now.getFullYear() + '-' + String(now.getMonth() + 1).padStart(2, '0') + '-' + String(now.getDate()).padStart(2, '0');
            const landingClassList = document.getElementById('landingClassList');
            
            try{
                // 1. Get all students and unique classes
                const s = await db.collection('students').get();
                const ts = s.size;
                const classesSet = new Set();
                s.forEach(doc => {
                    const d = doc.data();
                    if (d.kelas) classesSet.add(d.kelas);
                });
                const allClasses = Array.from(classesSet).sort();

                // 2. Get attendance for today
                const a = await db.collection('attendance')
                    .where('date','==',todayStr)
                    .where('type', '==', 'class')
                    .get();
                
                let p = 0;
                const submittedClasses = new Set();
                a.forEach(d=>{
                    const data = d.data();
                    if(data.status==='Hadir') p++;
                    if(data.class_name) submittedClasses.add(data.class_name);
                });

                // 3. Update Percent
                const pct = ts > 0 ? Math.round((p/ts)*100) : 0;
                document.getElementById('landingPercent').innerText = pct + '%';
                const cp = document.getElementById('landingCirclePath');
                cp.setAttribute('stroke-dasharray', `${pct}, 100`);
                cp.classList.remove('text-blue-600','text-yellow-500','text-red-500');
                if(pct < 50) cp.classList.add('text-red-500');
                else if(pct < 80) cp.classList.add('text-yellow-500');
                else cp.classList.add('text-blue-600');

                // 4. Update Class List UI
                landingClassList.innerHTML = '';
                if (allClasses.length === 0) {
                    landingClassList.innerHTML = '<div class="col-span-2 text-center text-xs text-slate-400 py-4">Tiada kelas didaftarkan</div>';
                } else {
                    allClasses.forEach(cls => {
                        const isDone = submittedClasses.has(cls);
                        const bg = isDone ? 'bg-emerald-50 border-emerald-100' : 'bg-slate-50 border-slate-100';
                        const txt = isDone ? 'text-emerald-700' : 'text-slate-500';
                        const icon = isDone ? '<i class="fa-solid fa-circle-check text-emerald-500"></i>' : '<i class="fa-regular fa-circle text-slate-300"></i>';
                        const statusText = isDone ? 'Selesai' : 'Belum';

                        landingClassList.innerHTML += `
                            <div class="${bg} border rounded px-3 py-2 flex items-center justify-between transition-all hover:shadow-sm">
                                <div class="flex items-center gap-2">
                                    ${icon}
                                    <span class="text-xs font-bold ${txt}">${cls}</span>
                                </div>
                                <span class="text-[10px] uppercase tracking-wider font-semibold ${isDone ? 'text-emerald-600' : 'text-slate-400'}">${statusText}</span>
                            </div>
                        `;
                    });
                }
            } catch(e){
                console.error(e);
                landingClassList.innerHTML = '<div class="col-span-2 text-center text-xs text-red-400">Gagal memuatkan data.</div>';
            } 
        }

        window.showAnalysisView=(v)=>{ ['daily','koku','class','student','monthly'].forEach(x=>{document.getElementById(`an-view-${x}`).classList.add('hidden');document.getElementById(`btn-an-${x}`).classList.remove('bg-white','shadow','text-slate-700');document.getElementById(`btn-an-${x}`).classList.add('text-slate-500');});document.getElementById(`an-view-${v}`).classList.remove('hidden');document.getElementById(`btn-an-${v}`).classList.add('bg-white','shadow','text-slate-700'); };

        // CRUD & Export
        window.downloadExcel=async(t)=>{if(t==='student'){const s=document.getElementById('anStudSelect').value;if(!s)return;const d=await db.collection('students').doc(s).get(),da=d.data();const dt=[["Analisis",da.nama],["Kelas",da.kelas],["RMT",da.rmt||'-'],["Unit",da.unit_beruniform||'-'],["Kelab",da.kelab_persatuan||'-'],["Sukan",da.sukan_permainan||'-'],[],["Bulan",document.getElementById('anStudMonth').value],["Tarikh","Status"]];document.querySelectorAll('#anStudAbsentList li').forEach(l=>dt.push([l.innerText,"Tidak Hadir"]));const ws=XLSX.utils.aoa_to_sheet(dt),wb=XLSX.utils.book_new();XLSX.utils.book_append_sheet(wb,ws,"Data");XLSX.writeFile(wb,`Analisis_${da.nama}.xlsx`);}else{const i=t==='class'?'tableAnClass':(t==='koku'?'tableKokuHistory':'tableAnMonth');const w=XLSX.utils.table_to_book(document.getElementById(i));XLSX.writeFile(w,`analisis_${t}.xlsx`);}};
        window.downloadPDF=(t)=>{const{jsPDF}=window.jspdf;const d=new jsPDF();if(t==='class'){d.text("Analisis Kelas",14,15);d.autoTable({html:'#tableAnClass',startY:20});}else if(t==='koku'){d.text("Rekod Kokurikulum",14,15);d.autoTable({html:'#tableKokuHistory',startY:20});}else if(t==='monthly'){d.text("Analisis Bulanan",14,15);d.autoTable({html:'#tableAnMonth',startY:20});}else{d.text(document.getElementById('anStudTitle').innerText,14,15);d.text(document.getElementById('anStudPresent').innerText+" Hadir",14,25);d.save('student.pdf');return;}d.save('report.pdf');};

        window.showLogin=async(t)=>{document.getElementById('view-landing').classList.add('hidden');if(t==='teacher'){document.getElementById('view-login-teacher').classList.remove('hidden');const s=document.getElementById('teacherSelect');s.innerHTML='<option>Loading...</option>';try{const snap=await db.collection('teachers').orderBy('nama').get();s.innerHTML='<option value="">Pilih Nama...</option>';snap.forEach(d=>{const o=document.createElement('option');o.value=d.id;o.text=d.data().nama;o.dataset.ic=d.data().ic_akhir4;o.dataset.role=d.data().role;s.appendChild(o);});}catch(e){}}else document.getElementById('view-login-admin').classList.remove('hidden');};
        window.goBack=()=>{document.getElementById('view-login-teacher').classList.add('hidden');document.getElementById('view-login-admin').classList.add('hidden');document.getElementById('view-landing').classList.remove('hidden');loadLandingStats();};
        window.logout=()=>{currentUser=null;document.getElementById('navbar').classList.add('hidden');document.getElementById('view-teacher-dashboard').classList.add('hidden');document.getElementById('view-admin-dashboard').classList.add('hidden');document.getElementById('view-landing').classList.remove('hidden');loadLandingStats();};
        window.handleTeacherLogin=async(e)=>{e.preventDefault();const s=document.getElementById('teacherSelect'),i=document.getElementById('teacherIc').value;if(s.options[s.selectedIndex].dataset.ic===i){const d=await db.collection('teachers').doc(s.value).get();currentUser={id:d.id,...d.data(),role:s.options[s.selectedIndex].dataset.role};const n=document.getElementById('navbarLinks');n.innerHTML='';if(currentUser.role==='admin'){const b=document.createElement('button');b.className="text-sm font-bold text-white bg-emerald-500 px-3 py-1 rounded";b.innerText='Panel Admin';b.onclick=()=>{document.getElementById('view-teacher-dashboard').classList.add('hidden');enterAdminDashboard();};n.appendChild(b);}enterTeacherDashboard();}else showToast("Salah","error");};
        
        // Updated handleAdminLogin to set 'superadmin' role
        window.handleAdminLogin=async(e)=>{
            e.preventDefault();
            const u=document.getElementById('adminUser').value,p=document.getElementById('adminPass').value;
            const s=await db.collection('admins').where('username','==',u).where('password','==',p).get();
            if(!s.empty){
                currentUser={ role: 'superadmin', username: u }; // Set role as superadmin
                enterAdminDashboard();
            } else {
                showToast("Gagal","error");
            }
        };
        
        async function enterTeacherDashboard(){document.getElementById('view-login-teacher').classList.add('hidden');document.getElementById('view-teacher-dashboard').classList.remove('hidden');document.getElementById('navbar').classList.remove('hidden');document.getElementById('userGreeting').innerText=`Hai, ${currentUser.nama}`;const s=document.getElementById('teacherClassSelect');s.innerHTML='<option>Loading...</option>';try{const sn=await db.collection('students').get();const c=new Set();sn.forEach(d=>{if(d.data().kelas)c.add(d.data().kelas);});s.innerHTML='<option value="">Pilih Kelas...</option>';Array.from(c).sort().forEach(x=>{const o=document.createElement('option');o.value=x;o.text=x;s.appendChild(o);});}catch(e){}}
        
        function enterAdminDashboard(){
            document.getElementById('view-login-admin').classList.add('hidden');
            document.getElementById('view-admin-dashboard').classList.remove('hidden');
            document.getElementById('navbar').classList.remove('hidden');
            
            // Show different title based on role
            const title = currentUser && currentUser.role === 'superadmin' ? 'Superadmin Panel' : 'Admin Panel';
            document.getElementById('userGreeting').innerText = title;
            
            const n=document.getElementById('navbarLinks');n.innerHTML='';[['teachers','Guru'],['students','Murid'],['history','Laporan']].forEach(([k,v])=>{const a=document.createElement('a');a.href="#";a.innerText=v;a.className="px-3 py-2 text-sm font-medium text-slate-500";a.onclick=()=>switchAdminTab(k);n.appendChild(a);});
            
            // Only show "Panel Guru" link if NOT a superadmin (meaning they are a teacher-admin)
            if (currentUser && currentUser.role !== 'superadmin') {
                const t=document.createElement('a');t.href="#";t.innerText="Panel Guru";t.className="px-3 py-2 text-sm font-medium text-emerald-600";t.onclick=()=>{document.getElementById('view-admin-dashboard').classList.add('hidden');enterTeacherDashboard();};n.appendChild(t);
            }
            
            switchAdminTab('teachers');
        }

        window.switchAdminTab=(id)=>{document.querySelectorAll('.admin-content').forEach(e=>e.classList.add('hidden'));document.getElementById(`tab-${id}`).classList.remove('hidden');if(id==='teachers')loadTeachers();if(id==='students')loadStudents();if(id==='history'){document.getElementById('historyDate').valueAsDate=new Date();loadHistoryMetadata();}};
        
        async function loadTeachers(){
            const t=document.getElementById('teacherTableBody');
            t.innerHTML='<tr><td colspan="4">Loading...</td></tr>';
            const s=await db.collection('teachers').orderBy('nama').get();
            t.innerHTML='';
            s.forEach(d=>{
                const x=d.data();
                const displayRole = x.role || 'guru';
                
                t.innerHTML+=`
                <tr class="bg-white border-b">
                    <td class="px-6 py-4">${escapeHtml(x.nama)}</td>
                    <td class="px-6 py-4">••••</td>
                    <td class="px-6 py-4 capitalize">${displayRole}</td>
                    <td class="text-right">
                        <button onclick="editTeacher(this)" 
                                data-id="${d.id}" 
                                data-name="${escapeHtml(x.nama)}" 
                                data-ic="${x.ic_akhir4 || ''}" 
                                data-role="${displayRole}" 
                                class="text-blue-600 mr-2">Edit</button>
                        <button onclick="confirmDelete('teachers','${d.id}')" class="text-red-600">Padam</button>
                    </td>
                </tr>`;
            });
        }
        async function loadStudents(){
            const t=document.getElementById('studentTableBody');
            t.innerHTML='<tr><td colspan="5" class="text-center p-4">Loading...</td></tr>';
            const s=await db.collection('students').get();
            allStudentsData=[];
            const classes = new Set();
            
            s.forEach(d=>{
                const data = d.data();
                allStudentsData.push({id:d.id, ...data});
                if(data.kelas) classes.add(data.kelas);
            });
            
            // Populate Class Filter
            const filterSel = document.getElementById('filterStudentClass');
            // Keep the default option
            filterSel.innerHTML = '<option value="">Semua Kelas</option>';
            Array.from(classes).sort().forEach(c => {
                const opt = document.createElement('option');
                opt.value = c;
                opt.innerText = c;
                filterSel.appendChild(opt);
            });

            // Initial Render
            applyStudentFilters();
        }

        function applyStudentFilters() {
            const search = document.getElementById('searchStudent').value.toLowerCase();
            const filterClass = document.getElementById('filterStudentClass').value;
            const sortType = document.getElementById('sortStudent').value;

            // Filter
            let filtered = allStudentsData.filter(s => {
                const matchName = s.nama.toLowerCase().includes(search);
                const matchClass = filterClass === "" || s.kelas === filterClass;
                return matchName && matchClass;
            });

            // Sort
            filtered.sort((a, b) => {
                if (sortType === 'name_asc') return a.nama.localeCompare(b.nama);
                if (sortType === 'name_desc') return b.nama.localeCompare(a.nama);
                if (sortType === 'class_asc') return a.kelas.localeCompare(b.kelas);
                return 0;
            });

            renderStudents(filtered);
        }

        function renderStudents(a){
            const t=document.getElementById('studentTableBody');
            t.innerHTML='';
            if(a.length === 0) {
                t.innerHTML='<tr><td colspan="5" class="text-center p-4 text-slate-500">Tiada rekod dijumpai</td></tr>';
                return;
            }
            
            a.slice(0,200).forEach(s=>{
                t.innerHTML+=`
                <tr class="bg-white border-b">
                    <td class="px-6 py-4">${escapeHtml(s.nama)}</td>
                    <td class="px-6 py-4">${s.kelas}</td>
                    <td class="px-6 py-4">${s.rmt}</td>
                    <td class="px-6 py-4 text-xs">${escapeHtml(s.unit_beruniform||'-')}<br>${escapeHtml(s.kelab_persatuan||'-')}</td>
                    <td class="text-right">
                        <button onclick="editStudent(this)" 
                                data-id="${s.id}" 
                                data-name="${escapeHtml(s.nama)}" 
                                data-class="${s.kelas}" 
                                data-rmt="${s.rmt}" 
                                data-unit="${escapeHtml(s.unit_beruniform||'')}" 
                                data-club="${escapeHtml(s.kelab_persatuan||'')}" 
                                data-sport="${escapeHtml(s.sukan_permainan||'')}" 
                                class="text-blue-600 mr-2">Edit</button>
                        <button onclick="confirmDelete('students','${s.id}')" class="text-red-600">Padam</button>
                    </td>
                </tr>`;
            });
        }

        let delTarget=null, delType='single';
        window.confirmDelete=(c,id)=>{delTarget={c,id};delType='single';document.getElementById('confirmModal').classList.remove('hidden');document.getElementById('confirmModal').classList.add('flex');};
        window.confirmDeleteAll=(c)=>{delTarget={c};delType='all';document.getElementById('confirmModal').classList.remove('hidden');document.getElementById('confirmModal').classList.add('flex');};
        window.closeConfirm=()=>{document.getElementById('confirmModal').classList.add('hidden');document.getElementById('confirmModal').classList.remove('flex');};
        document.getElementById('btnConfirmYes').onclick=async()=>{if(!delTarget)return;try{if(delType==='single')await db.collection(delTarget.c).doc(delTarget.id).delete();else{const s=await db.collection(delTarget.c).get();const bSize=400;let b=db.batch(),c=0;for(const d of s.docs){b.delete(d.ref);c++;if(c>=bSize){await b.commit();b=db.batch();c=0;}}if(c>0)await b.commit();}showToast("Berjaya");if(delTarget.c==='teachers')loadTeachers();else if(delTarget.c==='students')loadStudents();else loadHistory();}catch(e){}closeConfirm();};
        window.processCsvGuru = () => { const f = document.getElementById('csvGuru').files[0]; if(!f) return; const r = new FileReader(); r.onload=async(e)=>{ const l = e.target.result.replace(/\r/g,'\n').split('\n'); for(let x of l){ if(!x.trim())continue; const p=x.split(','); if(p.length>=2) await db.collection('teachers').add({nama:p[0].trim(),ic_akhir4:p[1].trim(), role:'guru'}); } loadTeachers(); }; r.readAsText(f); };
        window.processCsvMurid = () => { const f = document.getElementById('csvMurid').files[0]; if(!f) return; const r = new FileReader(); r.onload=async(e)=>{ const l = e.target.result.replace(/\r/g,'\n').split('\n'); let b=db.batch(), c=0; for(let x of l){ if(!x.trim())continue; const p=x.split(','); if(p.length>=2){ b.set(db.collection('students').doc(), {nama:p[0].trim(),kelas:p[1].trim(),rmt:p[2]?.trim()||'Tidak',unit_beruniform:p[3]?.trim()||'',kelab_persatuan:p[4]?.trim()||'',sukan_permainan:p[5]?.trim()||''}); c++; if(c>=400){ await b.commit(); b=db.batch(); c=0; } } } if(c>0) await b.commit(); loadStudents(); }; r.readAsText(f); };
        window.loadHistory=async()=>{ const d=document.getElementById('historyDate').value, c=document.getElementById('historyClassSelect').value, tb=document.getElementById('historyTableBody'); tb.innerHTML='<tr><td colspan="6">Mencari...</td></tr>'; let q=db.collection('attendance').where('date','==',d); if(c)q=q.where('class_name','==',c); const s=await q.get(); tb.innerHTML=''; s.forEach(d=>{const r=d.data();tb.innerHTML+=`<tr class="bg-white border-b"><td class="px-6 py-4">${r.date}</td><td class="px-6 py-4">${r.student_name}</td><td class="px-6 py-4">${r.extra_info||'-'}</td><td class="px-6 py-4">${r.status}</td><td class="px-6 py-4">${r.teacher_name}</td><td class="text-right"><button onclick="confirmDelete('attendance','${d.id}')" class="text-red-600">Padam</button></td></tr>`;}); };
    
        // Analysis
        window.analyzeClass = async () => { const d=document.getElementById('anClassDate').value, tb=document.getElementById('anClassBody'); if(!d)return; tb.innerHTML='<tr><td colspan="6">Loading...</td></tr>'; try{ const ss=await db.collection('students').get(), cm={}; ss.forEach(x=>{const k=x.data().kelas; if(!cm[k])cm[k]=0; cm[k]++;}); const as=await db.collection('attendance').where('date','==',d).where('type','==','class').get(), am={}; as.forEach(x=>{ const r=x.data(); if(r.status==='Hadir'){if(!am[r.class_name])am[r.class_name]=0; am[r.class_name]++;} am[r.class_name+'_sub']=true; }); tb.innerHTML=''; Object.keys(cm).sort().forEach(c=>{ const t=cm[c],p=am[c]||0, sub=am[c+'_sub'], a=sub?t-p:'-', pct=sub?Math.round((p/t)*100)+'%':'-', st=sub?'Selesai':'Belum'; tb.innerHTML+=`<tr class="bg-white border-b"><td class="px-6 py-4 font-bold">${c}</td><td class="text-center">${t}</td><td class="text-center text-green-600">${sub?p:'-'}</td><td class="text-center text-red-600">${a}</td><td class="text-center font-bold">${pct}</td><td class="text-center">${st}</td></tr>`; }); }catch(e){} };
        window.loadStudentDropdown=async()=>{const c=document.getElementById('anStudClass').value,s=document.getElementById('anStudSelect');s.disabled=true;s.innerHTML='<option>Loading...</option>';if(!c)return;const q=await db.collection('students').where('kelas','==',c).get();s.innerHTML='<option>Pilih Murid...</option>';let st=[];q.forEach(d=>st.push({id:d.id,...d.data()}));st.sort((a,b)=>a.nama.localeCompare(b.nama));st.forEach(x=>{const o=document.createElement('option');o.value=x.id;o.text=x.nama;s.appendChild(o);});s.disabled=false;};
        window.analyzeStudent=async()=>{const id=document.getElementById('anStudSelect').value,m=document.getElementById('anStudMonth').value;if(!id||!m)return;const n=document.getElementById('anStudSelect').options[document.getElementById('anStudSelect').selectedIndex].text; document.getElementById('anStudResult').classList.remove('hidden'); document.getElementById('anStudTitle').innerText=n; const q=await db.collection('attendance').where('student_id','==',id).get(); let t=0,p=0,l=[]; q.forEach(d=>{const r=d.data();if(r.date.startsWith(m)){t++;if(r.status==='Hadir')p++;else l.push(r.date);}}); document.getElementById('anStudTotal').innerText=t; document.getElementById('anStudPresent').innerText=p; document.getElementById('anStudAbsent').innerText=t-p; document.getElementById('anStudPct').innerText=t>0?Math.round((p/t)*100)+'%':'0%'; document.getElementById('anStudAbsentList').innerHTML=l.map(x=>`<li>${x}</li>`).join(''); };
        window.analyzeMonthly=async()=>{const m=document.getElementById('anMonthInput').value;if(!m)return;const s=m+"-01",e=m+"-31";const tb=document.getElementById('anMonthBody');tb.innerHTML='Loading...';const q=await db.collection('attendance').where('date','>=',s).where('date','<=',e).get();if(q.empty){tb.innerHTML='Tiada';return;}const ag={};q.forEach(d=>{const r=d.data(),c=r.class_name;if(!ag[c])ag[c]={t:0,p:0};ag[c].t++;if(r.status==='Hadir')ag[c].p++;});tb.innerHTML='';Object.keys(ag).sort().forEach(c=>{const d=ag[c],pct=Math.round((d.p/d.t)*100);tb.innerHTML+=`<tr class="bg-white border-b"><td class="px-6 py-4">${c}</td><td class="text-center font-bold">${pct}%</td><td>-</td></tr>`});};

        // --- NEWLY ADDED FUNCTIONS TO FIX ERRORS ---

        // Refactored editTeacher to use element dataset
        window.editTeacher = (btn) => {
            const d = btn.dataset;
            document.getElementById('editTeacherId').value = d.id;
            document.getElementById('inputTeacherName').value = d.name;
            document.getElementById('inputTeacherIc').value = d.ic;
            document.getElementById('inputTeacherRole').value = d.role;
            
            const btnSave = document.getElementById('btnSaveTeacher');
            btnSave.innerText = "Kemaskini Guru";
            btnSave.classList.replace('bg-emerald-600', 'bg-blue-600');
            btnSave.classList.replace('hover:bg-emerald-700', 'hover:bg-blue-700');
            
            document.getElementById('tab-teachers').scrollIntoView({behavior: 'smooth'});
        };

        // Fix saveTeacher logic
        window.saveTeacher = async (e) => {
            e.preventDefault();
            const id = document.getElementById('editTeacherId').value;
            const n = document.getElementById('inputTeacherName').value;
            const i = document.getElementById('inputTeacherIc').value;
            const r = document.getElementById('inputTeacherRole').value;
            
            try {
                if (id) {
                    await db.collection('teachers').doc(id).update({ nama: n, ic_akhir4: i, role: r });
                    showToast("Guru dikemaskini");
                } else {
                    await db.collection('teachers').add({ nama: n, ic_akhir4: i, role: r });
                    showToast("Guru ditambah");
                }
                document.getElementById('editTeacherId').value = '';
                e.target.reset();
                document.getElementById('btnSaveTeacher').innerText = "Simpan";
                document.getElementById('btnSaveTeacher').classList.replace('bg-blue-600', 'bg-emerald-600');
                document.getElementById('btnSaveTeacher').classList.replace('hover:bg-blue-700', 'hover:bg-emerald-700');
                loadTeachers();
            } catch (err) {
                console.error(err);
                showToast("Ralat menyimpan data", "error");
            }
        };

        // Refactored editStudent to use element dataset
        window.editStudent = (btn) => {
            const d = btn.dataset;
            document.getElementById('editStudentId').value = d.id;
            document.getElementById('inputStudentName').value = d.name;
            document.getElementById('inputStudentClass').value = d.class;
            document.getElementById('inputStudentRmt').value = d.rmt;
            document.getElementById('inputUnit').value = d.unit;
            document.getElementById('inputClub').value = d.club;
            document.getElementById('inputSport').value = d.sport;
            
            const btnSave = document.getElementById('btnSaveStudent');
            btnSave.innerText = "Kemaskini Murid";
            btnSave.classList.replace('bg-emerald-600', 'bg-blue-600');
            
            document.getElementById('tab-students').scrollIntoView({behavior: 'smooth'});
        };

        // Fix saveStudent logic
        window.saveStudent = async (e) => {
            e.preventDefault();
            const id = document.getElementById('editStudentId').value;
            const data = {
                nama: document.getElementById('inputStudentName').value,
                kelas: document.getElementById('inputStudentClass').value,
                rmt: document.getElementById('inputStudentRmt').value,
                unit_beruniform: document.getElementById('inputUnit').value,
                kelab_persatuan: document.getElementById('inputClub').value,
                sukan_permainan: document.getElementById('inputSport').value
            };

            try {
                if (id) {
                    await db.collection('students').doc(id).update(data);
                    showToast("Murid dikemaskini");
                } else {
                    await db.collection('students').add(data);
                    showToast("Murid ditambah");
                }
                document.getElementById('editStudentId').value = '';
                e.target.reset();
                document.getElementById('btnSaveStudent').innerText = "Simpan";
                document.getElementById('btnSaveStudent').classList.replace('bg-blue-600', 'bg-emerald-600');
                loadStudents();
            } catch (err) {
                console.error(err);
                showToast("Ralat", "error");
            }
        };

        // Fix filterStudentTable which is called in HTML but missing
        window.filterStudentTable = () => {
            const q = document.getElementById('searchStudent').value.toLowerCase();
            const rows = document.querySelectorAll('#studentTableBody tr');
            rows.forEach(r => {
                const txt = r.innerText.toLowerCase();
                r.style.display = txt.includes(q) ? '' : 'none';
            });
        };
        
        // Fix loadHistoryMetadata which was called but missing
        window.loadHistoryMetadata = async () => {
             const t = await db.collection('teachers').get();
             const s = await db.collection('students').get();
             document.getElementById('statTotalTeachers').innerText = t.size;
             document.getElementById('statTotalStudents').innerText = s.size;
             
             // Simple breakdown
             const classes = {};
             s.forEach(d => { const c = d.data().kelas; classes[c] = (classes[c] || 0) + 1; });
             let html = '';
             Object.keys(classes).sort().forEach(c => {
                 html += `<div class="flex justify-between border-b last:border-0 border-slate-100 py-1"><span>${c}</span><span class="font-bold">${classes[c]}</span></div>`;
             });
             document.getElementById('statClassBreakdown').innerHTML = html || '<div class="text-center py-2 text-slate-400">Tiada data</div>';
        };
    </script>
</body>
</html>